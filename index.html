<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tiro Maestro: Plan de Entrenamiento de Billar</title>
    <!-- NEW: Chart.js library for progress visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #f4f4f4;
            --container-bg: #fff;
            --text-color: #333;
            --header-color: #2c3e50;
            --accent-color: #3498db;
            --border-color: #ccc;
            --tab-bg: #ddd;
            --tab-active-bg: #457b9d;
            --tab-active-text: #fff;
            --day-section-bg: #f8f8f8;
            --current-day-bg: #e2f9e9;
            --current-day-border: #28a745;
            --important-note-bg: #fff3cd;
            --important-note-border: #ffc107;
            --activity-block-bg: #f0f8ff;
            --activity-block-border: #457b9d;
            --shot-desc-bg: #fcfcfc;
            --shot-desc-border: #aed6f1;
            --focus-color: #c0392b;
            --danger-color: #dc3545;
            --secondary-color: #6c757d;
            --warning-color: #ff9800; /* Color for Edit button & Stars */
        }

        body.dark-mode {
            --bg-color: #121212;
            --container-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --header-color: #ffffff;
            --accent-color: #5fa8e3;
            --border-color: #444;
            --tab-bg: #2c2c2c;
            --tab-active-bg: #5fa8e3;
            --tab-active-text: #121212;
            --day-section-bg: #2a2a2a;
            --current-day-bg: #2a3a2f;
            --current-day-border: #3c8d40;
            --important-note-bg: #332701;
            --important-note-border: #a67c00;
            --activity-block-bg: #212f3c;
            --activity-block-border: #5fa8e3;
            --shot-desc-bg: #2c2c2c;
            --shot-desc-border: #3e5a70;
            --danger-color: #e4606d;
            --secondary-color: #8c959d;
            --warning-color: #ffb74d; /* Lighter orange for dark mode */
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            line-height: 1.6; 
            color: var(--text-color); 
            margin: 0; 
            padding: 20px; 
            background-color: var(--bg-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .container { 
            max-width: 900px; 
            margin: auto; 
            background: var(--container-bg); 
            padding: 30px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            border: 1px solid var(--border-color);
            display: none; /* Hidden by default until setup is complete */
        }
        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .theme-switch-wrapper { display: flex; align-items: center; }
        .theme-switch { display: inline-block; height: 24px; position: relative; width: 48px; }
        .theme-switch input { display:none; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 24px; }
        .slider:before { background-color: #fff; bottom: 4px; content: ""; height: 16px; left: 4px; position: absolute; transition: .4s; width: 16px; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(24px); }
        
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .action-buttons button {
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-print, .btn-glossary { background-color: var(--accent-color); }
        .btn-shot-of-the-day { background-color: var(--accent-color); }
        .btn-reset-current { background-color: var(--secondary-color); }
        .btn-reset-all { background-color: var(--danger-color); }
        .btn-edit { background-color: var(--warning-color); }
        .btn-change-user { background-color: var(--secondary-color); }
        
        h1 { text-align: center; color: var(--header-color); margin-bottom: 5px; }
        .credits, .user-welcome { text-align: center; margin-top: 0; margin-bottom: 20px; font-size: 0.9em; color: var(--secondary-color); }
        .user-welcome { font-weight: bold; font-size: 1.1em; color: var(--text-color); }
        h2, h3 { border-bottom: 2px solid var(--accent-color); padding-bottom: 10px; margin-top: 20px; color: var(--header-color); }
        h3 { border-bottom-width: 1px; }
        h4 { color: var(--accent-color); margin-top: 20px; }
        h5 { margin-top: 0; color: var(--header-color); }
        ul { list-style-type: none; padding-left: 0; }
        .task-item { display: flex; align-items: center; margin-bottom: 8px; flex-wrap: wrap; }
        .task-item input[type="checkbox"] { margin-right: 10px; flex-shrink: 0; width: 18px; height: 18px; }
        .task-item label { flex-grow: 1; cursor: pointer; }
        .task-goal { font-size: 0.8em; color: var(--secondary-color); margin-left: 8px; font-style: italic; }
        
        .star-icon {
            cursor: pointer;
            font-size: 1.5rem;
            color: #ccc;
            margin-right: 10px;
            transition: color 0.2s, transform 0.2s;
            line-height: 1;
        }
        .star-icon:hover { transform: scale(1.2); }
        .star-icon.marked { color: var(--warning-color); }
        
        .rating-stars {
            display: flex;
            flex-direction: row-reverse;
            justify-content: flex-end;
            margin-left: auto;
            padding-left: 15px;
        }
        .rating-stars span {
            font-size: 1.5rem;
            color: #ccc;
            cursor: pointer;
            transition: color 0.2s;
        }
        .rating-stars:hover span,
        .rating-stars span:hover,
        .rating-stars span:hover ~ span {
            color: var(--warning-color);
        }
        .rating-stars span.filled {
             color: var(--warning-color);
        }

        .day-section { background-color: var(--day-section-bg); border: 1px solid var(--border-color); padding: 20px; margin-bottom: 20px; border-radius: 5px; transition: background-color 0.5s; }
        .day-focus { font-weight: bold; color: var(--focus-color); }
        
        .activity-block { margin-bottom: 15px; padding: 15px; border-left: 3px solid var(--activity-block-border); background-color: var(--activity-block-bg); border-radius: 4px; }
        .shot-description { margin-top: 15px; padding: 15px; border: 1px dashed var(--shot-desc-border); background-color: var(--shot-desc-bg); font-size: 0.9em; border-radius: 4px; }
        .citation { font-size: 0.8em; color: #777; vertical-align: super; }
        body.dark-mode .citation { color: #aaa; }
        .time-estimate { font-weight: bold; color: var(--accent-color); margin-left: 10px; }
        strong { color: var(--focus-color); }

        .tabs-container { position: relative; margin-top: 20px; }
        .tab-input { display: none; }
        .tab-label { float: left; padding: 10px 15px; cursor: pointer; background: var(--tab-bg); border: 1px solid var(--border-color); border-bottom: none; border-radius: 5px 5px 0 0; margin-right: 2px; transition: background 0.3s, color 0.3s; white-space: nowrap; }
        .tab-label:hover { opacity: 0.8; }
        .tab-input:checked + .tab-label { background: var(--tab-active-bg); color: var(--tab-active-text); border: 1px solid var(--tab-active-bg); border-bottom: 1px solid var(--container-bg); z-index: 1; position: relative; margin-bottom: -1px; font-weight: bold; }
        .tab-content-wrapper { border: 1px solid var(--border-color); background: var(--container-bg); padding: 20px; border-radius: 0 0 5px 5px; clear: both; }
        .tab-content { display: none; }
        
        .progress-container { margin-bottom: 20px; }
        .progress-bar { width: 100%; background-color: var(--tab-bg); border-radius: 5px; overflow: hidden; border: 1px solid var(--border-color); }
        .progress-bar-fill { height: 20px; width: 0%; background-color: var(--current-day-border); transition: width 0.5s ease-in-out; text-align: center; color: white; font-weight: bold; line-height: 20px; }
        .task-counter { text-align: right; font-size: 0.9em; margin-top: 5px; color: var(--text-color); }

        .diary-section, .assessment-section { margin-top: 20px; }
        .diary-section label, .assessment-section h4 { font-weight: bold; color: var(--accent-color); }
        .diary-textarea { width: 100%; min-height: 120px; margin-top: 5px; background-color: var(--day-section-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 4px; padding: 8px; box-sizing: border-box; resize: vertical; }
        
        .mobile-nav { display: none; width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 5px; border: 1px solid var(--border-color); background-color: var(--container-bg); color: var(--text-color); }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: var(--container-bg); padding: 30px; border-radius: 8px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); max-width: 450px; width: 90%; }
        .modal-buttons button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 10px; }
        #modal-confirm { background-color: var(--danger-color); color: white; }
        #modal-cancel { background-color: var(--secondary-color); color: white; }
        
        #welcome-modal .modal-content button, #load-user-modal .modal-content button { width: 100%; padding: 12px; margin-bottom: 10px; font-size: 1.1em; }
        .user-profile-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .user-profile-item button { flex-grow: 1; }
        .delete-profile-btn { background-color: var(--danger-color); color: white; border: none; border-radius: 5px; cursor: pointer; padding: 8px; margin-left: 10px; }
        #load-user-list p { color: var(--secondary-color); }
        
        #new-user-modal .modal-content, #term-definition-modal .modal-content { text-align: left; }
        #new-user-modal h2, #term-definition-modal h2 { margin-top: 0; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; }
        .form-group input { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid var(--border-color); background-color: var(--day-section-bg); color: var(--text-color); box-sizing: border-box; }
        .form-group button { padding: 12px; font-size: 1.1em; border: none; border-radius: 5px; cursor: pointer; }
        .form-buttons { display: flex; gap: 10px; }
        .form-buttons button { width: 100%; }
        
        .error-message { color: var(--danger-color); font-size: 0.9em; margin-top: 5px; display: none; }
        
        .days-checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; background-color: var(--day-section-bg); padding: 15px; border-radius: 5px; }
        .days-checkbox-group label { display: flex; align-items: center; cursor: pointer; padding: 8px; border-radius: 4px; transition: background-color 0.2s; }
        .days-checkbox-group input { margin-right: 8px; }
        .days-checkbox-group label:hover { background-color: rgba(0,0,0,0.05); }
        body.dark-mode .days-checkbox-group label:hover { background-color: rgba(255,255,255,0.05); }


        .important-note { background-color: var(--important-note-bg); border-left: 4px solid var(--important-note-border); padding: 15px; margin-top: 10px; border-radius: 4px; }
        
        #todays-focus-container {
            background-color: var(--current-day-bg);
            border: 1px solid var(--current-day-border);
            border-left-width: 5px;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        #todays-focus-container h3 {
            margin-top: 0;
            border-bottom: none;
            color: var(--current-day-border);
        }
        #todays-focus-container p {
            margin-bottom: 15px;
        }
        #todays-focus-container button {
            background-color: var(--current-day-border);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: opacity 0.2s;
        }
        #todays-focus-container button:hover {
            opacity: 0.85;
        }

        .glossary-term {
            color: var(--accent-color);
            text-decoration: underline;
            text-decoration-style: dotted;
            cursor: pointer;
            position: relative;
        }

        #tooltip {
            position: absolute;
            display: none;
            background-color: var(--container-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1001;
            max-width: 300px;
            font-size: 0.9em;
        }

        #glossary-modal .modal-content, #term-definition-modal .modal-content, #recommendation-modal .modal-content, #diagram-modal .modal-content, #shot-of-the-day-modal .modal-content, #achievement-unlocked-modal .modal-content {
            max-width: 700px;
            text-align: left;
            height: auto;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
        }
        
        #session-modal .modal-content {
            max-width: 500px;
        }
        #timer-display {
            font-size: 5rem;
            font-weight: bold;
            color: var(--accent-color);
            margin: 20px 0;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .modal-header h2 { margin: 0; border: none; }
        .modal-close-btn { font-size: 1.5rem; cursor: pointer; border: none; background: none; color: var(--text-color); }
        
        #glossary-content, #fitness-content { overflow-y: auto; flex-grow: 1; padding-right: 15px; }
        #glossary-content dl dt { font-weight: bold; color: var(--accent-color); margin-top: 15px; }
        #glossary-content dl dd { margin-left: 20px; }
        .highlight-term { background-color: var(--important-note-bg); transition: background-color 0.5s; }

        #reinforce-list {
            list-style: none;
            padding: 0;
        }
        .reinforce-item {
            background-color: var(--day-section-bg);
            border-left: 4px solid var(--warning-color);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .reinforce-item-text {
            flex-grow: 1;
        }
        .reinforce-item-source {
            font-size: 0.85em;
            color: var(--secondary-color);
            font-style: italic;
            display: block;
        }

        #streak-container {
            text-align: center;
            padding: 20px;
            background-color: var(--day-section-bg);
            border-radius: 8px;
            margin-bottom: 20px;
        }
        #streak-counter {
            font-size: 3rem;
            font-weight: bold;
            color: var(--accent-color);
        }
        
        #achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }
        .achievement-item {
            background-color: var(--day-section-bg);
            border: 1px solid var(--border-color);
            border-left-width: 5px;
            border-left-color: #ccc;
            padding: 20px;
            border-radius: 5px;
            opacity: 0.5;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .achievement-item.unlocked {
            opacity: 1;
            border-left-color: var(--current-day-border);
        }
        .achievement-icon {
            font-size: 3rem;
            line-height: 1;
        }
        .achievement-details h4 {
            margin: 0 0 5px 0;
            color: var(--header-color);
            border: none;
            padding: 0;
        }
        .achievement-details p {
            margin: 0;
            font-size: 0.9em;
            color: var(--secondary-color);
        }

        @media (max-width: 768px) {
            .tabs-container .tab-label { display: none; }
            .mobile-nav { display: block; }
            .container { padding: 15px; }
            .header-controls { flex-direction: column; align-items: flex-start; }
            .action-buttons button { margin-left: 0; margin-right: 5px; }
        }
    </style>
</head>
<body>
    <div id="welcome-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Bienvenido a Tiro Maestro</h2>
            <p>Selecciona una opci√≥n para comenzar.</p>
            <div class="modal-buttons">
                <button id="btn-load-user">Cargar Perfil</button>
                <button id="btn-import-profile">Importar Perfil</button>
                <button id="btn-new-user">Nuevo Perfil</button>
                <button id="btn-guest-user">Modo Invitado</button>
            </div>
        </div>
    </div>

    <div id="load-user-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2>Cargar Perfil</h2>
            <div id="load-user-list"></div>
            <div class="modal-buttons">
                 <button class="btn-back-to-welcome">Volver</button>
            </div>
        </div>
    </div>
    
    <div id="new-user-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2 id="new-user-title">Crear Nuevo Perfil</h2>
            <p>Personaliza tu camino hacia la maestr√≠a.</p>
            <form id="setup-form">
                <div class="form-group">
                    <label for="user-name">Tu Nombre:</label>
                    <input type="text" id="user-name" required>
                    <p class="error-message" id="name-error">Por favor, introduce un nombre.</p>
                </div>
                <div class="form-group">
                    <label>D√≠as de Entrenamiento:</label>
                    <div class="days-checkbox-group" id="training-days-group">
                        <label><input type="checkbox" value="Lunes">Lunes</label>
                        <label><input type="checkbox" value="Martes">Martes</label>
                        <label><input type="checkbox" value="Mi√©rcoles">Mi√©rcoles</label>
                        <label><input type="checkbox" value="Jueves">Jueves</label>
                        <label><input type="checkbox" value="Viernes">Viernes</label>
                        <label><input type="checkbox" value="S√°bado">S√°bado</label>
                        <label><input type="checkbox" value="Domingo">Domingo</label>
                    </div>
                    <p class="error-message" id="days-error">Por favor, selecciona al menos 2 d√≠as.</p>
                </div>
                <div class="form-group form-buttons">
                    <button type="submit" style="background-color: var(--accent-color); color: white;">Crear Mi Plan</button>
                    <button type="button" id="btn-cancel-edit" style="display: none; background-color: var(--secondary-color); color: white;">Cancelar</button>
                </div>
            </form>
            <div id="back-button-container" class="modal-buttons">
                <button class="btn-back-to-welcome" style="background-color: var(--secondary-color);">Volver</button>
            </div>
        </div>
    </div>

    <div id="reset-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3>Confirmar Reinicio</h3>
            <p>¬øEst√°s seguro de que quieres borrar este progreso? Esta acci√≥n no se puede deshacer.</p>
            <div class="modal-buttons">
                <button id="modal-cancel">Cancelar</button>
                <button id="modal-confirm">S√≠, Reiniciar</button>
            </div>
        </div>
    </div>

     <div id="overwrite-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3>Sobrescribir Perfil</h3>
            <p id="overwrite-modal-text"></p>
            <div class="modal-buttons">
                <button id="overwrite-cancel">Cancelar</button>
                <button id="overwrite-confirm" style="background-color: var(--danger-color); color: white;">S√≠, Sobrescribir</button>
            </div>
        </div>
    </div>

    <div id="alert-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3 id="alert-modal-title"></h3>
            <p id="alert-modal-text"></p>
            <div class="modal-buttons">
                <button id="alert-ok" style="background-color: var(--accent-color); color: white;">Aceptar</button>
            </div>
        </div>
    </div>

    <div id="glossary-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Glosario de Billar</h2>
                <button class="modal-close-btn">&times;</button>
            </div>
            <div id="glossary-content"></div>
        </div>
    </div>

    <div id="term-definition-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
             <div class="modal-header">
                <h2 id="term-modal-title"></h2>
                <button class="modal-close-btn">&times;</button>
            </div>
            <p id="term-modal-definition"></p>
        </div>
    </div>

     <div id="recommendation-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
             <div class="modal-header">
                <h2>Recomendaci√≥n Semanal</h2>
                <button class="modal-close-btn">&times;</button>
            </div>
            <p id="recommendation-text"></p>
        </div>
    </div>

    <div id="diagram-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
             <div class="modal-header">
                <h2 id="diagram-modal-title">Diagrama del Tiro</h2>
                <button class="modal-close-btn">&times;</button>
            </div>
            <div style="padding: 10px; text-align: center;">
                <img id="diagram-modal-image" src="" alt="Diagrama del tiro" style="max-width: 100%; height: auto; border-radius: 5px; border: 1px solid var(--border-color);">
            </div>
        </div>
    </div>

    <div id="shot-of-the-day-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
             <div class="modal-header">
                <h2>üé≤ Tiro del D√≠a</h2>
                <button class="modal-close-btn">&times;</button>
            </div>
            <div id="shot-of-the-day-content"></div>
        </div>
    </div>

    <div id="achievement-unlocked-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="text-align: center;">
            <h2 style="color: var(--warning-color);">¬°Logro Desbloqueado!</h2>
            <div id="unlocked-achievement-icon" style="font-size: 4rem; margin: 15px 0;"></div>
            <h3 id="unlocked-achievement-name"></h3>
            <p id="unlocked-achievement-desc"></p>
            <button id="achievement-ok-btn" style="background-color: var(--accent-color); color: white; padding: 10px 20px; border-radius: 5px; border: none; cursor: pointer;">¬°Genial!</button>
        </div>
    </div>

    <div id="session-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3>Sesi√≥n de Pr√°ctica</h3>
            <p>¬°Conc√©ntrate! Cuando el tiempo termine, podr√°s registrar tus notas.</p>
            <div id="timer-display">00:00</div>
            <div class="modal-buttons">
                <button id="session-stop-btn" style="background-color: var(--danger-color); color: white;">Terminar Sesi√≥n</button>
            </div>
        </div>
    </div>


    <div id="tooltip"></div>

    <div class="container" id="main-container">
        <div class="header-controls">
            <div class="theme-switch-wrapper">
                <label class="theme-switch" for="theme-toggle">
                    <input type="checkbox" id="theme-toggle">
                    <span class="slider"></span>
                </label>
                <span style="margin-left: 8px;">Modo Oscuro</span>
            </div>
            <div class="action-buttons">
                <button id="btn-shot-of-the-day" class="btn-shot-of-the-day">Tiro del D√≠a</button>
                <button id="btn-export-profile" class="btn-change-user">Exportar Perfil</button>
                <button id="btn-change-user" class="btn-change-user">Cambiar Usuario</button>
                <button id="btn-glossary" class="btn-glossary">Glosario</button>
                <button id="btn-edit-plan" class="btn-edit">Editar Plan</button>
                <button id="btn-print" class="btn-print">Imprimir / PDF</button>
                <button id="btn-reset-current-week" class="btn-reset-current">Reiniciar Semana</button>
                <button id="btn-reset-all" class="btn-reset-all">Reiniciar Todo</button>
            </div>
        </div>
        
        <h1>Tiro Maestro</h1>
        <p id="user-welcome-message" class="user-welcome"></p>
        <p class="credits">Adaptado por: Juan Miguel Rios Redondo</p>
        <p class="important-note">Este plan progresa a trav√©s de la "Torre de Entrenamiento". Avance a la siguiente semana solo cuando cumpla el <strong>Criterio de Avance</strong>.</p>
        
        <div id="todays-focus-container" style="display: none;"></div>

        <select id="mobile-nav" class="mobile-nav"></select>
        <div class="tabs-container" id="tabs-container"></div>
    </div>

    <input type="file" id="import-file-input" accept=".json" style="display: none;">

    <script>
    // --- DATA SOURCE ---
    const proPoolPlayers = ["Efren Reyes", "Shane Van Boening", "Earl Strickland", "Jayson Shaw", "Mike Sigel", "Francisco Bustamante"];
    const glossaryData = {
        "Stop Shot": { translation: "Parada Seca", definition: "Un tiro donde la bola blanca se detiene completamente despu√©s de impactar la bola objetivo. Se logra golpeando la bola blanca en su centro vertical exacto para que llegue desliz√°ndose (sin rotaci√≥n) al punto de contacto." },
        "Stun": { translation: "Deslizamiento / Bola Aturdida", definition: "El estado de la bola blanca cuando se desliza sobre el pa√±o sin rotaci√≥n hacia adelante o hacia atr√°s. Es la base para el Stop Shot y para controlar la l√≠nea tangente." },
        "Follow": { translation: "Seguida / Correr la bola", definition: "Un tiro donde la bola blanca contin√∫a movi√©ndose hacia adelante despu√©s de contactar la bola objetivo. Se logra golpeando la bola blanca por encima de su centro (topspin)." },
        "Draw": { translation: "Retroceso", definition: "Un tiro donde la bola blanca retrocede despu√©s de contactar la bola objetivo. Se logra golpeando la bola blanca por debajo de su centro (backspin)." },
        "Stroke": { translation: "Golpeo / Mec√°nica de Tiro", definition: "El movimiento completo del brazo y el taco al ejecutar un tiro. Incluye el p√©ndulo del brazo, la aceleraci√≥n y la finalizaci√≥n (follow-through)." },
        "Sidespin": { translation: "Efecto Lateral / 'English'", definition: "Efecto aplicado a la bola blanca al golpearla a la izquierda o derecha de su centro vertical. Altera la trayectoria de la bola blanca despu√©s de tocar una banda." },
        "Tangent Line": { translation: "L√≠nea Tangente", definition: "Una l√≠nea imaginaria a 90 grados de la l√≠nea de tiro en el punto de contacto entre la bola blanca y la objetivo. Es la direcci√≥n que tomar√° la bola blanca si llega con 'stun' (desliz√°ndose)." },
        "Shape Zone": { translation: "Zona de Posici√≥n", definition: "El √°rea en la mesa donde quieres que la bola blanca aterrice para tener un buen tiro a la siguiente bola objetivo. Planificar hacia una zona es m√°s efectivo que apuntar a un punto exacto." },
        "Squirt": { translation: "Deflexi√≥n / Desviaci√≥n", definition: "La desviaci√≥n de la trayectoria inicial de la bola blanca causada por el uso de sidespin. Los tacos de baja deflexi√≥n (low deflection) minimizan este efecto." },
        "Swerve": { translation: "Curva / Comba", definition: "La ligera curva que toma la trayectoria de la bola blanca, especialmente en tiros lentos con sidespin o cuando el taco est√° elevado. Es causado por la fricci√≥n con el pa√±o." },
        "Bank Shot": { translation: "Tiro por Banda", definition: "Un tiro donde la bola objetivo es enviada a una o m√°s bandas antes de entrar en la tronera." },
        "Kick Shot": { translation: "Tiro de Rebote / Patada", definition: "Un tiro donde la bola blanca es enviada a una o m√°s bandas antes de contactar la bola objetivo." },
        "Carom": { translation: "Carambola", definition: "Un tiro donde la bola blanca, despu√©s de contactar una primera bola objetivo, contacta una segunda bola (intencionadamente o no)." },
        "Puente": { translation: "Puente", definition: "La configuraci√≥n de la mano que gu√≠a la varilla del taco. Un puente estable (abierto o cerrado) es fundamental para la precisi√≥n." },
        "Follow-through": { translation: "Finalizaci√≥n del Golpe", definition: "La continuaci√≥n del movimiento del taco hacia adelante despu√©s de haber impactado la bola blanca. Es crucial para un golpeo suave y preciso." },
        "Choking up": { translation: "Agarrar Corto / Subir la Mano", definition: "Una t√©cnica donde el jugador desliza su mano de agarre (la de atr√°s) m√°s arriba en la culata del taco. Esto acorta la palanca, ofreciendo m√°s control y precisi√≥n en tiros delicados o cuando el espacio es reducido, a costa de potencia." },
        "Rail Shot": { translation: "Tiro a lo largo de la Banda", definition: "Un tiro donde la bola objetivo est√° congelada (pegada) o muy cerca de la banda. Requiere un golpeo preciso para evitar que la banda afecte negativamente la trayectoria de la bola objetivo." },
        "Break Shot": { translation: "Tiro de Saque / Rompimiento", definition: "El primer tiro de la partida, usado para dispersar el tri√°ngulo de bolas. El objetivo es entronerar una bola legalmente y/o dejar la bola blanca en una buena posici√≥n para continuar." },
        "Universal Positioning": { translation: "Posicionamiento Universal", definition: "Un concepto avanzado de control de la bola blanca donde, para un mismo tiro, existen m√∫ltiples combinaciones de velocidad, efecto y punter√≠a que pueden llevar la bola blanca a la misma zona de posici√≥n (Shape Zone)." },
        "Scratch": { translation: "Falta / Rasgu√±o", definition: "Una falta que ocurre cuando la bola blanca cae en una de las troneras. Resulta en la p√©rdida del turno y, dependiendo de las reglas, el oponente obtiene 'bola en mano'." },
        "Off-Table Fitness": { translation: "Acondicionamiento F√≠sico", definition: "Entrenamiento f√≠sico realizado fuera de la mesa de billar, enfocado en fortalecer m√∫sculos clave para la postura (core), la estabilidad y el control del taco (agarre, antebrazo)." }
    };
    const physicalTrainingData = [
        { title: "Fortaleza del Core: Planchas", content: "<strong>¬øQu√© es?</strong> La plancha es un ejercicio isom√©trico (mantener una posici√≥n fija) que fortalece todo tu 'core': los m√∫sculos abdominales, la espalda baja y los gl√∫teos. Es el pilar de una postura estable.<br><strong>¬øC√≥mo se hace?</strong><br>1. <strong>Posici√≥n Inicial:</strong> Acu√©state boca abajo. Apoya tu peso sobre los antebrazos y las puntas de los pies.<br>2. <strong>Alineaci√≥n:</strong> Levanta las caderas hasta que tu cuerpo forme una l√≠nea recta desde la cabeza hasta los talones. Evita que tus caderas se caigan o se levanten demasiado.<br>3. <strong>Activaci√≥n:</strong> Contrae los m√∫sculos del abdomen y los gl√∫teos para mantener la espalda recta.<br>4. <strong>Rutina de 10 minutos:</strong> Sost√©n la posici√≥n durante 45-60 segundos, descansa 30 segundos y repite el ciclo.<br><strong>¬øPor qu√© es importante?</strong> Un core fuerte es la base de una postura inm√≥vil, previene el balanceo al tirar y aumenta la resistencia en partidas largas." },
        { title: "Fuerza de Agarre y Antebrazo", content: "<strong>¬øQu√© es?</strong> Son ejercicios dise√±ados para fortalecer los m√∫sculos de tus manos, mu√±ecas y antebrazos, permitiendo un control m√°s fino y relajado del taco.<br><strong>¬øC√≥mo se hace?</strong><br>1. <strong>Apretar Pelota Antiestr√©s:</strong> Apri√©tala con fuerza durante 5 segundos y relaja. Haz 3 series de 15 repeticiones con cada mano.<br>2. <strong>Curls de Mu√±eca:</strong> Sentado, apoya tu antebrazo en tu muslo con la palma hacia arriba. Sost√©n una botella de agua peque√±a y, usando solo la mu√±eca, sube y baja la mano. Haz 3 series de 15 repeticiones.<br><strong>¬øPor qu√© es importante?</strong> Un agarre m√°s fuerte permite un toque m√°s suave y sensible, ya que no necesitas apretar el taco con tensi√≥n. Esto mejora la precisi√≥n y el 'feel' del tiro." }
    ];
    const allTrainingDays = [
        { 
            id: 1, 
            originalWeek: 1, 
            title: 'Lunes: Velocidad y Stop Shot', 
            focus: 'Sentir las 5 velocidades de [[stroke]] y dominar el [[Stop Shot]].', 
            estTime: '45 min', 
            tasks: [ 
                { id: 't1', text: '<b>Shots #1-8 (Control de Velocidad):</b> Practique las velocidades Slow, Medium y Fast.', goal: '10 Intentos | Meta: 8-10 Aciertos', type: 'Control' }, 
                { id: 't2', text: '<b>Shot #9 ([[Stop Shot]]):</b> Enfoque: Full Bottom para lograr el "[[stun]]". Mantenga el cuerpo <strong>inm√≥vil</strong>.', goal: '10 Intentos | Meta: 8-10 Aciertos', type: 'Stop Shot' } 
            ], 
            keyShot: { title: 'Tiro Clave: Shot #9 (Stop Shot)', desc: 'El "[[stop shot]]" es el m√°s importante. Requiere que la bola blanca se est√© "deslizando" ([[stun]]) al contacto.'},
            diagrama: '' 
        },
        { id: 2, originalWeek: 1, title: 'Martes: Follow y Draw (Rectos)', focus: 'Aislar la mec√°nica de [[Follow]] y [[Draw]] en tiros rectos.', estTime: '45 min', tasks: [ { id: 't1', text: '<b>Shot #12 ([[Follow]] Slow):</b> Agarre relajado, [[stroke]] <strong>a trav√©s</strong> ([[follow-through]]) completo.', goal: '10 Intentos | Meta: 7-9 Aciertos', type: 'Follow' }, { id: 't2', text: '<b>Shot #14 ([[Draw]] Slow):</b> Baje el [[puente]], mantenga el taco lo m√°s <strong>nivelado</strong> posible.', goal: '10 Intentos | Meta: 7-9 Aciertos', type: 'Draw' }, { id: 't3', text: '<b>[[Off-Table Fitness]]:</b> 10 min de planchas y ejercicios de agarre.' } ] },
        { id: 3, originalWeek: 1, title: 'Jueves: Fundamentos Avanzados y Rutina', focus: 'Integrar la rutina completa de 6 pasos (Set, See, Prime, Pause, Stroke, Stop).', estTime: '60 min', tasks: [ { id: 't1', text: '<b>Shots #16-17 (Near Rail):</b> Practique el [[puente]] de banda estable.', goal: '10 Intentos | Meta: 6-8 Aciertos', type: 'Rail Shot' }, { id: 't2', text: '<b>Shot #19 (Elevated Cue):</b> Nunca usar [[Sidespin]] al elevar.', goal: '5 Intentos | Meta: 3-4 Aciertos', type: 'Especial' }, { id: 't3', text: '<b>Rutina Completa (15 min):</b> Pr√°ctica en seco (sin bolas). Repita los 6 pasos: <strong>Set</strong> (alinearse), <strong>See</strong> (visualizar), <strong>Prime</strong> (movimientos de calentamiento), <strong>Pause</strong> (pausa de 1-2 seg antes del golpe), <strong>Stroke</strong> (golpeo fluido) y <strong>Stop</strong> (quedarse abajo inm√≥vil tras el golpe). Preste m√°xima atenci√≥n a la quietud durante la <strong>Pausa</strong> y el <strong>Stop</strong>.' } ] },
        { id: 4, originalWeek: 1, title: 'Viernes: Test de Fundamentos y Correcci√≥n', focus: 'Autoevaluaci√≥n honesta y correcci√≥n de h√°bitos.', estTime: '45 min', tasks: [ { id: 't1', text: '<b>Test R√°pido (Around the World):</b> 5 tiros fundamentales al azar.', goal: 'Meta: 5 de 5 Aciertos' }, { id: 't2', text: '<b>An√°lisis de Defectos:</b> Grabe su [[Stop Shot]]. Revise si su codo cae o si su agarre se tensa.' }, { id: 't3', text: '<b>[[Off-Table Fitness]]:</b> 10 min de planchas y ejercicios de agarre.' } ], criteria: 'Lograr el <strong>[[Stop Shot]] (Parada Seca)</strong> consistentemente (8/10 veces).'},
        { id: 5, originalWeek: 2, title: 'Lunes: Stun Shot y L√≠nea Tangente (90¬∞)', focus: 'Usar [[Stun]] para que la bola blanca viaje <strong>exactamente a 90 grados</strong> de la [[Tangent Line]].', estTime: '45 min', tasks: [ { id: 't1', text: '<b>Stun B√°sico (#45-48):</b> Visualice la [[Tangent Line]]. Los [[Stun]] shots son los m√°s consistentes.', goal: '10 Intentos | Meta: 8-10 Aciertos', type: 'Stun' }, { id: 't2', text: '<b>Stun con Ajuste (#49-51):</b> Use Bottom spin y ajuste la velocidad.', goal: '10 Intentos | Meta: 7-9 Aciertos', type: 'Stun' } ] },
        { id: 6, originalWeek: 2, title: 'Martes: Follow Shot y Regla de 30¬∞', focus: 'Usar [[Follow]] (Topspin) para que la bola blanca se curve <strong>hacia adelante</strong> de la [[Tangent Line]].', estTime: '45 min', tasks: [ { id: 't1', text: '<b>Follow B√°sico (#20-24):</b> Para el half-ball aim (#22), la bola blanca se desviar√° unos 30 grados.', goal: '10 Intentos | Meta: 8-10 Aciertos', type: 'Follow' }, { id: 't2', text: '<b>Follow con Rail (#25-27):</b> Ajuste la fuerza. La bola blanca perder√° velocidad al rebotar.', goal: '10 Intentos | Meta: 7-9 Aciertos', type: 'Follow' } ] },
        { id: 7, originalWeek: 2, title: 'Jueves: Stun y Follow a Velocidad Media', focus: 'Controlar la bola blanca en tiros de m√°s distancia y velocidad. Aplicar la estrategia de la <strong>[[Shape Zone]]</strong>.', estTime: '60 min', tasks: [ { id: 't1', text: '<b>Stun Medium Speed (#52-57):</b> <strong>Enfoque:</strong> Mantener el shooting arm vertical.', goal: '10 Intentos | Meta: 6-8 Aciertos', type: 'Stun' }, { id: 't2', text: '<b>Follow Medium Speed (#28-34):</b> Acelere su [[stroke]] a trav√©s de la bola blanca.', goal: '10 Intentos | Meta: 6-8 Aciertos', type: 'Follow' }, { id: 't3', text: '<b>Off-Table (15 min):</b> Visualizaci√≥n de [[Shape Zone]] y 10 min de planchas.' } ] },
        { id: 8, originalWeek: 2, title: 'Viernes: Test de Stun y Follow Avanzado', focus: 'Evaluar la aplicaci√≥n de [[Stun]] y [[Follow]] en tiros que requieren control de velocidad y carril.', estTime: '60 min', tasks: [ { id: 't1', text: '<b>Stun Avanzado (#58-67):</b> Use menos spin y velocidad para aumentar consistencia.', goal: '10 Intentos | Meta: 7-9 Aciertos', type: 'Stun' }, { id: 't2', text: '<b>Follow Fast Speed (#38-44):</b> Golpee m√°s arriba para generar m√°s topspin.', goal: '10 Intentos | Meta: 6-8 Aciertos', type: 'Follow' }, { id: 't3', text: '<b>An√°lisis Posicional:</b> ¬øEl error fue de velocidad, spin o lineamiento?' } ], criteria: 'Lograr <b>[[Stun]] Shot</b> y <b>[[Follow]] Shot</b> con √°ngulo consistentemente (8/10 veces).'},
        { id: 9, originalWeek: 3, title: 'Lunes: Draw B√°sico y Velocidad Media', focus: 'Generar [[Draw]] suficiente con velocidad Slow/Medium y practicar la inmovilidad post-[[stroke]].', estTime: '45 min', tasks: [ { id: 't1', text: '<b>Draw B√°sico (#68-72):</b> El [[Draw]] requiere un mejor [[stroke]]. <strong>Enfoque:</strong> Inmovilidad.', goal: '10 Intentos | Meta: 7-9 Aciertos', type: 'Draw'}, { id: 't2', text: '<b>Draw Medium Speed (#73-77):</b> Use un punto de contacto m√°s bajo para generar m√°s spin sin m√°s velocidad.', goal: '10 Intentos | Meta: 6-8 Aciertos', type: 'Draw'}, { id: 't3', text: '<b>[[Off-Table Fitness]] (15 min):</b> Manipulaci√≥n de monedas y pelotas antiestr√©s.'}]},
        { id: 10, originalWeek: 3, title: 'Martes: Draw Shot de Distancia y Velocidad R√°pida', focus: 'Mantener la rectitud del [[stroke]] en [[Draw]] de larga distancia y alta velocidad.', estTime: '45 min', tasks: [ { id: 't1', text: '<b>Draw Largo (#78, #80):</b> El [[Draw]] se vuelve m√°s dif√≠cil con la distancia.', goal: '10 Intentos | Meta: 5-7 Aciertos', type: 'Draw'}, { id: 't2', text: '<b>Draw Fast Speed (#81-83):</b> Mantenga siempre una mu√±eca y un agarre sueltos.', goal: '10 Intentos | Meta: 5-7 Aciertos', type: 'Draw'}]},
        { id: 11, originalWeek: 3, title: 'Jueves: Draw Cr√≠tico y Estrategia', focus: 'Usar [[Draw]] para posicionamiento fuera de la l√≠nea recta (tiros con rail).', estTime: '60 min', tasks: [ { id: 't1', text: '<b>Draw Cr√≠tico (#84):</b> Este tiro tiene demasiado √°ngulo para [[Draw]] recto; debe usar el rail.', goal: '10 Intentos | Meta: 6-8 Aciertos', type: 'Draw'}, { id: 't2', text: '<b>Game Shark Simple (15 min):</b> Juegue 5 tiros de un set, donde el objetivo es usar el <strong>m√≠nimo [[Draw]]</strong> posible.'}]},
        { id: 12, originalWeek: 3, title: 'Viernes: Test de Draw y Simplicidad', focus: 'Integrar [[Draw]] en la filosof√≠a de <strong>simplicidad</strong> ([[Follow]]/[[Stun]] > [[Draw]]).', estTime: '45 min', tasks: [ { id: 't1', text: '<b>Test de Draw Cr√≠tico (3x):</b> Repita Shot #84. Eval√∫e la inmovilidad de su cuerpo.', goal: '3 Intentos | Meta: 2-3 Aciertos', type: 'Draw'}, { id: 't2', text: '<b>Principios de Simplicidad:</b> Repase los principios de simplicidad (ej. prefiera tiros como el #22 [[Follow]] o #48 [[Stun]] antes que [[Draw]] o [[Sidespin]] complejos). Use menos efecto.'}], criteria: 'Lograr <strong>[[Draw]] Shot</strong> consistentemente (7/10 veces).'},
        { id: 13, originalWeek: 4, title: 'Lunes: Sidespin B√°sico (Running vs. Hold-up)', focus: 'Entender el cambio de √°ngulo en el rebote causado por [[Sidespin]]. Usarlo solo cuando es <strong>necesario</strong>.', estTime: '45 min', tasks: [ { id: 't1', text: '<b>Shot #87 (Running English):</b> [[Sidespin]] en la direcci√≥n del rebote &rarr; el √°ngulo se ensancha. <strong>Enfoque:</strong> Compensar [[Squirt]].', goal: '10 Intentos | Meta: 7-9 Aciertos', type: 'Sidespin'}, { id: 't2', text: '<b>Shot #91 (Hold-up English):</b> [[Sidespin]] opuesto al rebote &rarr; el √°ngulo se acorta.', goal: '10 Intentos | Meta: 7-9 Aciertos', type: 'Sidespin'}]},
        { id: 14, originalWeek: 4, title: 'Martes: Universal Positioning (Near Pocket)', focus: 'Controlar la bola blanca cuando la bola objetivo est√° cerca del bolsillo.', estTime: '45 min', tasks: [ { id: 't1', text: '<b>Follow/Stun Near Pocket (#114-116):</b> Usar Slow Speed para controlar la posici√≥n.', goal: '10 Intentos | Meta: 8-10 Aciertos', type: 'Posicionamiento'}, { id: 't2', text: '<b>Draw Near Pocket (#117):</b> Use Bottom spin para evitar que la bola blanca se "pegue" al rail.', goal: '10 Intentos | Meta: 7-9 Aciertos', type: 'Posicionamiento'}, { id: 't3', text: '<b>Sidespin Posicional (#127):</b> Use [[Sidespin]] para cambiar el √°ngulo off the rail. Compense [[Squirt]] (#128).', goal: '10 Intentos | Meta: 6-8 Aciertos', type: 'Posicionamiento'}]},
        { id: 15, originalWeek: 4, title: 'Jueves: Sidespin y Draw Combinados', focus: 'Experimentar con [[Draw]] + [[Sidespin]] (que causa <strong>[[Swerve]]</strong>) y compensar el <strong>[[Squirt]]</strong>.', estTime: '60 min', tasks: [ { id: 't1', text: '<b>Sidespin Fast (#109-113):</b> [[Draw]] + [[Sidespin]] &rarr; [[Swerve]] (la bola blanca curva en la mesa). Evitar esto en juego real.', goal: '10 Intentos | Meta: 5-7 Aciertos', type: 'Sidespin'}, { id: 't2', text: '<b>Rutina Mental (15 min):</b> Practique la visualizaci√≥n de la curva de la bola blanca ([[Swerve]]) en 5 tiros imaginarios.'}]},
        { id: 16, originalWeek: 4, title: 'Viernes: Test de Consistencia y Simplicidad', focus: 'Reconfirmar la filosof√≠a: usar [[Sidespin]] solo cuando es esencial.', estTime: '45 min', tasks: [ { id: 't1', text: '<b>Test de Sidespin Bank (#87):</b> Repita 5 veces. Eval√∫e si la bola blanca sigue el √°ngulo esperado.', goal: '5 Intentos | Meta: 3-4 Aciertos', type: 'Sidespin'}, { id: 't2', text: '<b>Simulaci√≥n de Juego:</b> Juegue 5 sets de Shot Count. <strong>Regla:</strong> Si usa [[Sidespin]], pierda 1 punto de penalidad.'}], criteria: 'Lograr <strong>Sidespin [[Bank Shot]]</strong> y <strong>[[Universal Positioning]]</strong> (7/10 veces).'},
        { id: 17, originalWeek: 5, title: 'Lunes: Universal Positioning II - Draw y Rail', focus: 'Tiros complejos con [[Draw]], velocidad y el uso de √°ngulos en lugar de spin.', estTime: '45 min', tasks: [ { id: 't1', text: '<b>√Ångulos vs. Spin (#135):</b> Posicionar usando √°ngulos y velocidad es a menudo m√°s f√°cil que usar mucho spin.', goal: '10 Intentos | Meta: 7-9 Aciertos', type: 'Posicionamiento'}, { id: 't2', text: '<b>Draw R√°pido (#131):</b> Fast Speed. Baje el punto de contacto para generar m√°s spin con menos velocidad.', goal: '10 Intentos | Meta: 6-8 Aciertos', type: 'Draw'}]},
        { id: 18, originalWeek: 5, title: 'Martes: Universal Positioning III - Maestr√≠a', focus: 'Dominar los tiros de posicionamiento donde hay m√∫ltiples soluciones. <strong>Encontrar la m√°s simple.</strong>', estTime: '45 min', tasks: [ { id: 't1', text: '<b>Tiros de Variedad (#138):</b> Cuando una bola est√° cerca de una tronera, puede usar una variedad de l√≠neas, spins y velocidades.', goal: '10 Intentos | Meta: 8-10 Aciertos', type: 'Posicionamiento'}, { id: 't2', text: '<b>Tiro [[Carom]] (#139):</b> Requiere precisi√≥n. Use un agarre y una mu√±eca <strong>sueltos</strong>.', goal: '10 Intentos | Meta: 6-8 Aciertos', type: 'Carom'}]},
        { id: 19, originalWeek: 5, title: 'Jueves: Scratches (Follow y Stun)', focus: '<strong>Aprender a no raspar</strong> ([[Scratch]]) con [[Follow]] y [[Stun]], identificando las zonas de peligro.', estTime: '60 min', tasks: [ { id: 't1', text: '<b>Follow Scratches (#178, #181):</b> Practique tiros que lleven la bola blanca directamente a la tronera. <strong>Objetivo:</strong> Conocer los √°ngulos de peligro.', goal: '5 Intentos | Meta: 5 Aciertos', type: 'Control'}, { id: 't2', text: '<b>Stun Scratches (#182, #184):</b> Tirar a una bola objetivo cerca del punto de cabeza o pie con [[stun]] causar√° un [[scratch]].', goal: '5 Intentos | Meta: 5 Aciertos', type: 'Control'}]},
        { id: 20, originalWeek: 5, title: 'Viernes: Scratches (Draw) y Manejo de Errores', focus: 'Identificar fallos comunes en el [[Draw]] que causan foul.', estTime: '45 min', tasks: [ { id: 't1', text: '<b>Draw Scratches (#185-187):</b> Despu√©s del [[stroke]], mueva su mano de [[puente]] fuera del camino de la bola blanca.', goal: '5 Intentos | Meta: 5 Aciertos', type: 'Control'}, { id: 't2', text: '<b>An√°lisis de Control:</b> Si accidentalmente puso demasiado Bottom spin en un [[stun shot]], la bola blanca har√° [[draw]]. Aprenda a controlarlo.'}], criteria: 'Dominar la <strong>[[Universal Positioning]] Avanzada</strong> y reconocer las condiciones para el <strong>[[Scratch]]</strong>.'},
        { id: 21, originalWeek: 6, title: 'Lunes: Rail Shots (Fundamentos y Bridge)', focus: 'Mantener el taco nivelado y el [[puente]] estable cuando la bola est√° cerca de la banda.', estTime: '45 min', tasks: [ { id: 't1', text: '<b>Tiros B√°sicos en Rail (#143-144):</b> Practique golpear la bola objetivo y rail al mismo tiempo.', goal: '10 Intentos | Meta: 7-9 Aciertos', type: 'Rail Shot'}, { id: 't2', text: '<b>Rail Posicional (#145-146):</b> Use [[Follow]]/[[Draw]] para posicionar. Asegure un [[puente]] estable.', goal: '10 Intentos | Meta: 6-8 Aciertos', type: 'Rail Shot'}]},
        { id: 22, originalWeek: 6, title: 'Martes: Rail Shots (Avanzados y Sidespin)', focus: 'Usar Running English para ensanchar el √°ngulo y la t√©cnica de "[[choking up]]".', estTime: '45 min', tasks: [ { id: 't1', text: '<b>Running English en Rail (#155):</b> [[Sidespin]] en la direcci√≥n del rail &rarr; aumenta velocidad y ensancha el rebote.', goal: '10 Intentos | Meta: 6-8 Aciertos', type: 'Rail Shot'}, { id: 't2', text: '<b>T√©cnica "[[Choking up]]" (#171):</b> Coloque su mano de tiro un poco m√°s arriba en el taco para m√°s control.', goal: '10 Intentos | Meta: 7-9 Aciertos', type: 'Rail Shot'}]},
        { id: 23, originalWeek: 6, title: 'Jueves: Banks, Kicks y Combinaciones', focus: 'Tiros de riesgo: usarlos solo como <strong>√∫ltimo recurso</strong>. Los [[Bank Shot]] son inconsistentes.', estTime: '60 min', tasks: [ { id: 't1', text: '<b>[[Bank Shot]] (#188-191):</b> Un [[stroke]] m√°s r√°pido acorta el √°ngulo de rebote de la bola objetivo.', goal: '10 Intentos | Meta: 4-6 Aciertos', type: 'Bank Shot'}, { id: 't2', text: '<b>[[Kick Shot]] (#192-194):</b> Vaya a dos bandas con la bola blanca para aterrizar lejos de la banda.', goal: '10 Intentos | Meta: 5-7 Aciertos', type: 'Kick Shot'}]},
        { id: 24, originalWeek: 6, title: 'Viernes: Test de Consistencia en el Rail', focus: 'Evaluar la consistencia en el uso de [[Follow]]/[[Stun]]/[[Sidespin]] en tiros complejos.', estTime: '45 min', tasks: [ { id: 't1', text: '<b>Test de [[Bank Shot]] Posicional (#191):</b> Eval√∫e su capacidad para usar un [[Bank Shot]] para posicionar la bola blanca.', goal: '5 Intentos | Meta: 2-3 Aciertos', type: 'Bank Shot'}, { id: 't2', text: '<b>An√°lisis de Simplicidad:</b> Por cada tiro, piense si un tiro de <strong>[[Follow]]/[[Stun]]</strong> habr√≠a funcionado mejor.'}], criteria: 'Lograr <strong>[[Rail Shot]]</strong> y <strong>[[Bank Shot]]</strong> con control (6/10 veces).'},
        { id: 25, originalWeek: 7, title: 'Lunes: Tiros de Over Ball y Break', focus: 'Pruebas de fuego finales para los fundamentos ([[Break Shot]] y Elevaci√≥n de taco).', estTime: '45 min', tasks: [ { id: 't1', text: '<b>Tiros Sobre Bolas (#198-199):</b> Requiere elevaci√≥n del taco. Use <strong>[[choking up]]</strong>.', goal: '10 Intentos | Meta: 6-8 Aciertos', type: 'Especial'}, { id: 't2', text: '<b>[[Break Shot]] (#200):</b> Practique el power break. <strong>Enfoque:</strong> Controlar la bola blanca al centro.', goal: '10 Intentos | Meta: 7-9 Aciertos', type: 'Break Shot'}]},
        { id: 26, originalWeek: 7, title: 'Martes: Rutina y Adaptaci√≥n Estrat√©gica', focus: 'Aplicar la <strong>estrategia adaptativa</strong> (seleccionar tiros basados en el rendimiento actual).', estTime: '45 min', tasks: [ { id: 't1', text: '<b>Calentamiento Competitivo:</b> Inicie con tiros f√°ciles (#1-3) y progrese a dif√≠ciles.'}, { id: 't2', text: '<b>Estrategia Adaptativa:</b> Juegue 9-ball. Si est√° inconsistente, solo elija tiros de <strong>[[Stop Shot]] o [[Follow]]</strong>.'}, { id: 't3', text: '<b>[[Off-Table Fitness]]:</b> 10 min de cardio para simular la fatiga de un torneo.'}]},
        { id: 27, originalWeek: 7, title: 'Jueves: Juego Mental y Presi√≥n', focus: 'Practicar la ejecuci√≥n perfecta bajo presi√≥n simulada. <strong>El rendimiento es mental.</strong>', estTime: '60 min', tasks: [ { id: 't1', text: '<b>Visualizaci√≥n de Torneo:</b> Imag√≠nese en la mesa, con p√∫blico. Visualice su rutina.'}, { id: 't2', text: '<b>Reinicio Bajo Presi√≥n:</b> Faille un tiro a prop√≥sito. Use su mantra ("Siguiente tiro") y reinicie la rutina.'}]},
        { id: 28, originalWeek: 7, title: 'Viernes: Competencia y Cierre del Ciclo', focus: 'Integrar todos los componentes de la "Torre de Entrenamiento".', estTime: '45 min', tasks: [ { id: 't1', text: '<b>Juego Competitivo:</b> Compita. <strong>Objetivo:</strong> No ganar, sino mantener el proceso.'}, { id: 't2', text: '<b>An√°lisis Post-Juego:</b> ¬øEn qu√© momento se rompi√≥ su rutina? Esos son los tiros que debe repetir.'}, { id: 't3', text: '<b>Cierre del Ciclo:</b> Vuelva a la Semana 1. La maestr√≠a requiere pr√°ctica continua.'}], criteria: 'Mantener un <strong>rendimiento constante</strong> bajo presi√≥n y aplicar la <strong>rutina completa</strong> en el 90% de los tiros.'}
    ];

    const weekThemes = {
        1: "Fundamentos del Golpeo", 2: "Posicionamiento con Stun y Follow", 3: "Dominio del Tiro de Retroceso (Draw)", 4: "Introducci√≥n al Efecto Lateral (Sidespin)", 5: "Posicionamiento Avanzado y Control de Faltas", 6: "Juego de Bandas y Tiros Complejos", 7: "Estrategia y Mente Competitiva"
    };

    const achievementsData = {
        'fundamentals': { name: 'Maestro de Fundamentos', desc: 'Completa la Semana 1 al 100%.', icon: 'üèÜ', condition: (progress, userConfig, totalWeeks) => {
            const daysPerWeek = userConfig.selectedDays.length;
            const daysInWeek1 = allTrainingDays.slice(0, daysPerWeek);
            const tasksInWeek1 = daysInWeek1.flatMap(d => d.tasks.map(t => `w1-d${d.id}-${t.id}`));
            return tasksInWeek1.every(taskId => progress[taskId] === true);
        }},
        'draw-master': { name: 'Se√±or del Retroceso', desc: 'Completa todas las sesiones de la Semana 3.', icon: 'üî©', condition: (progress, userConfig, totalWeeks) => {
             const daysPerWeek = userConfig.selectedDays.length;
             const week3Index = Math.floor(allTrainingDays.findIndex(d => d.originalWeek === 3) / daysPerWeek);
             const week3Number = week3Index + 1;
             const week3StartIndex = week3Index * daysPerWeek;
             const daysInWeek3 = allTrainingDays.slice(week3StartIndex, week3StartIndex + daysPerWeek).filter(d => d.originalWeek === 3);
             const tasksInWeek3 = daysInWeek3.flatMap(d => d.tasks.map(t => `w${week3Number}-d${d.id}-${t.id}`));
             return tasksInWeek3.length > 0 && tasksInWeek3.every(taskId => progress[taskId] === true);
        }},
        'problem-solver': { name: 'Ojo de Halc√≥n', desc: 'Supera 5 tiros que hab√≠as marcado como problem√°ticos.', icon: 'ü¶Ö', condition: (progress) => {
            const markedShots = progress.markedShots || {};
            const completedMarked = Object.keys(markedShots).filter(taskId => progress[taskId] === true);
            return completedMarked.length >= 5;
        }},
        'perfect-week': { name: 'Semana Perfecta', desc: 'Completa el 100% de las tareas de cualquier semana.', icon: 'üéØ', condition: (progress, userConfig, totalWeeks) => {
            const daysPerWeek = userConfig.selectedDays.length;
            let dayIndexOffset = 0;
            for (let i = 1; i <= totalWeeks; i++) {
                const daysInThisWeek = allTrainingDays.slice(dayIndexOffset, dayIndexOffset + daysPerWeek);
                if (daysInThisWeek.length === 0) continue;
                const tasksInWeek = daysInThisWeek.flatMap(d => d.tasks.map(t => `w${i}-d${d.id}-${t.id}`));
                if (tasksInWeek.length > 0 && tasksInWeek.every(taskId => progress[taskId] === true)) {
                    return true; // Found at least one perfect week
                }
                dayIndexOffset += daysPerWeek;
            }
            return false;
        }},
    };

    document.addEventListener('DOMContentLoaded', () => {
        const STORAGE_PREFIX = 'tiroMaestroProfiles_v1';
        let currentProfile = null;
        let isGuest = false;
        let myProgressChart = null;
        let myPerformanceChart = null;
        let sessionTimerInterval = null;

        const mainContainer = document.getElementById('main-container');
        const welcomeModal = document.getElementById('welcome-modal');
        const loadUserModal = document.getElementById('load-user-modal');
        const newUserModal = document.getElementById('new-user-modal');
        const setupForm = document.getElementById('setup-form');
        
        // --- Utility Functions ---
        function getStorage() { return isGuest ? sessionStorage : localStorage; }
        function getProfiles() { return JSON.parse(getStorage().getItem(STORAGE_PREFIX)) || {}; }
        function saveProfiles(profiles) { getStorage().setItem(STORAGE_PREFIX, JSON.stringify(profiles)); }

        function showModal(modal) {
            [welcomeModal, loadUserModal, newUserModal].forEach(m => m.style.display = 'none');
            if(modal) modal.style.display = 'flex';
        }

        function showCustomAlert(title, message) {
            document.getElementById('alert-modal-title').textContent = title;
            document.getElementById('alert-modal-text').textContent = message;
            document.getElementById('alert-modal').style.display = 'flex';
        }
        
        // --- Welcome Modal Logic ---
        document.getElementById('btn-new-user').addEventListener('click', () => {
            setupForm.dataset.mode = 'new';
            document.getElementById('new-user-title').textContent = 'Crear Nuevo Perfil';
            const userNameInput = document.getElementById('user-name');
            userNameInput.value = '';
            userNameInput.disabled = false;
            userNameInput.placeholder = `Ej: ${proPoolPlayers[Math.floor(Math.random() * proPoolPlayers.length)]}`;
            setupForm.querySelector('button[type="submit"]').textContent = 'Crear Mi Plan';
            document.getElementById('btn-cancel-edit').style.display = 'none';
            document.getElementById('back-button-container').style.display = 'block';
            isGuest = false;
            showModal(newUserModal);
        });
        document.getElementById('btn-guest-user').addEventListener('click', () => {
            setupForm.dataset.mode = 'guest';
            document.getElementById('new-user-title').textContent = 'Iniciar como Invitado';
            const userNameInput = document.getElementById('user-name');
            userNameInput.value = 'Invitado';
            userNameInput.placeholder = 'Invitado';
            userNameInput.disabled = false;
            setupForm.querySelector('button[type="submit"]').textContent = 'Iniciar Sesi√≥n';
            document.getElementById('btn-cancel-edit').style.display = 'none';
            document.getElementById('back-button-container').style.display = 'block';
            isGuest = true;
            showModal(newUserModal);
        });
        document.getElementById('btn-load-user').addEventListener('click', () => {
            const profiles = JSON.parse(localStorage.getItem(STORAGE_PREFIX)) || {};
            const userList = document.getElementById('load-user-list');
            userList.innerHTML = '';
            const userNames = Object.keys(profiles);
            if (userNames.length > 0) {
                userNames.forEach(name => {
                    const item = document.createElement('div');
                    item.className = 'user-profile-item';
                    const btn = document.createElement('button');
                    btn.textContent = name;
                    btn.onclick = () => startSession(name);
                    const delBtn = document.createElement('button');
                    delBtn.textContent = '‚úñ';
                    delBtn.className = 'delete-profile-btn';
                    delBtn.onclick = (e) => {
                        e.stopPropagation();
                        showCustomAlert('Confirmar Eliminaci√≥n', `¬øEst√°s seguro de que quieres eliminar el perfil "${name}"? Se perder√° todo el progreso. Esta acci√≥n no se puede deshacer.`);
                        // This uses the generic alert modal now as a confirmation. A more robust solution would be a dedicated confirmation modal.
                        document.getElementById('alert-ok').onclick = () => {
                            delete profiles[name];
                            localStorage.setItem(STORAGE_PREFIX, JSON.stringify(profiles));
                            document.getElementById('btn-load-user').click(); // Refresh list
                            document.getElementById('alert-modal').style.display = 'none';
                        };
                    };
                    item.appendChild(btn);
                    item.appendChild(delBtn);
                    userList.appendChild(item);
                });
            } else {
                userList.innerHTML = '<p>No hay perfiles guardados.</p>';
            }
            showModal(loadUserModal);
        });
        document.querySelectorAll('.btn-back-to-welcome').forEach(btn => {
            btn.addEventListener('click', () => showModal(welcomeModal));
        });

        // --- Session Start ---
        function startSession(userName, config) {
            currentProfile = userName;
            isGuest = !!config; 
            let userConfig;

            if (isGuest) {
                userConfig = config;
            } else {
                const profiles = getProfiles();
                
                if (profiles[currentProfile] && profiles[currentProfile].config) {
                    userConfig = profiles[currentProfile].config;
                } else {
                     console.error("Error: Could not find profile or config for:", userName);
                    showModal(welcomeModal);
                    return;
                }
            }
            
            if (userConfig && userConfig.selectedDays) {
                generatePlan(currentProfile, userConfig.selectedDays);
            } else {
                 console.error("Error: Invalid or missing user configuration for:", userName);
                 showModal(welcomeModal);
            }
        }
        
        function parseGlossaryTerms(text) {
            return text.replace(/\[\[(.*?)\]\]/g, (match, term) => {
                const cleanTerm = term.trim();
                const key = Object.keys(glossaryData).find(k => k.toLowerCase() === cleanTerm.toLowerCase());
                if (key) return `<span class="glossary-term" data-term="${key}">${cleanTerm}</span>`;
                return cleanTerm;
            });
        }

        function generatePlan(userName, selectedDays) {
            document.getElementById('user-welcome-message').textContent = `Plan de Entrenamiento para: ${userName}`;
            const tabsContainer = document.getElementById('tabs-container');
            const mobileNav = document.getElementById('mobile-nav');
            
            tabsContainer.innerHTML = ''; mobileNav.innerHTML = '';
            let htmlTabs = '', htmlContentWrapper = '', mobileNavOptions = '';
            
            const daysPerWeek = selectedDays.length;
            const totalWeeks = Math.ceil(allTrainingDays.length / daysPerWeek);
            let dayIndex = 0;

            for (let i = 1; i <= totalWeeks; i++) {
                htmlTabs += `<input type="radio" name="tabs" id="tab${i}" class="tab-input" ${i === 1 ? 'checked' : ''}><label for="tab${i}" class="tab-label">Semana ${i}</label>`;
                mobileNavOptions += `<option value="tab${i}">Semana ${i}</option>`;
                
                let weekContent = `<div id="content${i}" class="tab-content" style="${i === 1 ? 'display: block;' : ''}">`;
                const daysInThisWeek = allTrainingDays.slice(dayIndex, dayIndex + daysPerWeek);
                const uniqueThemes = [...new Set(daysInThisWeek.map(d => weekThemes[d.originalWeek]))];
                weekContent += `<h2>Semana ${i}: ${uniqueThemes.join(' y ')}</h2>`;

                if(daysInThisWeek.length > 0 && daysInThisWeek[daysInThisWeek.length-1].criteria) {
                    weekContent += `<p><strong>Criterio de Avance:</strong> ${parseGlossaryTerms(daysInThisWeek[daysInThisWeek.length-1].criteria)}</p>`;
                }
                weekContent += `<div class="progress-container"><div class="task-counter"></div><div class="progress-bar"><div class="progress-bar-fill"></div></div></div>`;

                daysInThisWeek.forEach((day, index) => {
                    const dayName = selectedDays[index % selectedDays.length];
                    let dayHTML = `<div class="day-section" id="day-section-${day.id}">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <h4>${dayName}: ${day.title.split(': ')[1]}</h4>
                            <button class="btn-start-session" data-time="${day.estTime}" data-day-id="${day.id}" style="background-color: var(--current-day-border); color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; white-space: nowrap;">Iniciar Sesi√≥n</button>
                        </div>
                        <p class="day-focus">Foco: ${parseGlossaryTerms(day.focus)}</p>
                        <div class="activity-block"><h5>Tareas: <span class="time-estimate">(${day.estTime})</span></h5><ul>`;
                    day.tasks.forEach(task => {
                        const checkboxId = `w${i}-d${day.id}-${task.id}`;
                        dayHTML += `<li class="task-item">
                                        <span class="star-icon" data-task-id="${checkboxId}" title="Marcar como tiro problem√°tico">&#9734;</span>
                                        <input type="checkbox" id="${checkboxId}">
                                        <label for="${checkboxId}">${parseGlossaryTerms(task.text)} ${task.goal ? `<span class="task-goal">(${task.goal})</span>` : ''}</label>
                                        <div class="rating-stars" data-task-id="${checkboxId}">
                                            <span data-value="5" title="5 Estrellas">&#9734;</span>
                                            <span data-value="4" title="4 Estrellas">&#9734;</span>
                                            <span data-value="3" title="3 Estrellas">&#9734;</span>
                                            <span data-value="2" title="2 Estrellas">&#9734;</span>
                                            <span data-value="1" title="1 Estrella">&#9734;</span>
                                        </div>
                                    </li>`;
                    });
                    dayHTML += `</ul></div>`;
                    
                    if (day.diagrama) {
                        dayHTML += `
                            <button class="btn-view-diagram" data-diagram-title="${day.title.split(': ')[1]}" data-day-id="${day.id}" style="background-color: var(--focus-color); color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin-top: -5px; margin-bottom: 10px;">
                                Ver Diagrama del Tiro Clave
                            </button>
                        `;
                    }
                    
                    if(day.keyShot) dayHTML += `<div class="shot-description"><h5>${parseGlossaryTerms(day.keyShot.title)}</h5><p>${parseGlossaryTerms(day.keyShot.desc)}</p></div>`;
                    const diaryId = `w${i}-d${day.id}-notes`;
                    dayHTML += `<div class="diary-section"><label for="${diaryId}">Diario de Pr√°ctica:</label><textarea id="${diaryId}" class="diary-textarea" placeholder="1. ¬øCu√°l fue mi mayor reto hoy?\n2. ¬øQu√© descubrimiento t√©cnico o mental hice?\n3. ¬øEn qu√© me enfocar√© en la pr√≥xima sesi√≥n?"></textarea></div>`;
                    
                    if(index === daysInThisWeek.length - 1){
                        dayHTML += `<div class="assessment-section" style="display: none;">
                            <h4>Autoevaluaci√≥n Semanal</h4>
                            <form id="assessment-form-w${i}">
                                <div class="form-group">
                                    <label>¬øSientes que cumpliste el Criterio de Avance de esta semana?</label>
                                    <label><input type="radio" name="criteria-met" value="yes" required> S√≠, consistentemente.</label>
                                    <label><input type="radio" name="criteria-met" value="somewhat"> Parcialmente, a√∫n fallo a veces.</label>
                                    <label><input type="radio" name="criteria-met" value="no"> No, me cost√≥ mucho.</label>
                                    <p class="error-message" style="margin-top:10px;">Por favor, selecciona una opci√≥n.</p>
                                </div>
                                 <div class="form-group">
                                    <label>Califica tu confianza con las t√©cnicas de esta semana (1=Baja, 5=Alta)</label>
                                    <select name="confidence">
                                        <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option>
                                    </select>
                                </div>
                                <button type="button" class="btn-get-recommendation" data-week="${i}" style="background-color: var(--accent-color); color: white; padding: 10px; border: none; border-radius: 5px; cursor: pointer;">Ver Recomendaci√≥n</button>
                            </form>
                        </div>`;
                    }
                    
                    dayHTML += `</div>`;
                    weekContent += dayHTML;
                });
                dayIndex += daysPerWeek;
                weekContent += `</div>`;
                htmlContentWrapper += weekContent;
            }
            
            // Add Achievements Tab
            mobileNavOptions += `<option value="tab-achievements">Logros</option>`;
            htmlTabs += `<input type="radio" name="tabs" id="tab-achievements" class="tab-input"><label for="tab-achievements" class="tab-label">Logros</label>`;
            let achievementsContent = `<div id="content-achievements" class="tab-content">
                <h2>Mis Logros y Rachas</h2>
                <div id="streak-container">
                    <p>Racha de Pr√°ctica Actual</p>
                    <div id="streak-counter">0 üî•</div>
                </div>
                <div id="achievements-grid"></div>
            </div>`;
            htmlContentWrapper += achievementsContent;

            // Add Fitness Tab
            mobileNavOptions += `<option value="tab-fitness">Fitness</option>`;
            htmlTabs += `<input type="radio" name="tabs" id="tab-fitness" class="tab-input"><label for="tab-fitness" class="tab-label">Fitness</label>`;
            let fitnessContent = `<div id="content-fitness" class="tab-content"><div id="fitness-content"><h2>Entrenamiento F√≠sico Fuera de la Mesa</h2>`;
            physicalTrainingData.forEach(item => {
                fitnessContent += `<h3>${item.title}</h3><p>${item.content}</p>`;
            });
            fitnessContent += `</div></div>`;
            htmlContentWrapper += fitnessContent;

            // Add Reinforce Tab
            mobileNavOptions += `<option value="tab-reinforce">Tiros a Reforzar</option>`;
            htmlTabs += `<input type="radio" name="tabs" id="tab-reinforce" class="tab-input"><label for="tab-reinforce" class="tab-label">Tiros a Reforzar</label>`;
            let reinforceContent = `<div id="content-reinforce" class="tab-content">
                <h2>Mis Tiros a Reforzar (&#9733;)</h2>
                <p>Aqu√≠ encontrar√°s una lista de todos los ejercicios que has marcado como problem√°ticos para un f√°cil acceso y repaso.</p>
                <ul id="reinforce-list"></ul>
            </div>`;
            htmlContentWrapper += reinforceContent;
            
            // Add Analysis Tab
            mobileNavOptions += `<option value="tab-analysis">An√°lisis</option>`;
            htmlTabs += `<input type="radio" name="tabs" id="tab-analysis" class="tab-input"><label for="tab-analysis" class="tab-label">An√°lisis</label>`;
            let analysisContent = `<div id="content-analysis" class="tab-content">
                <h2>An√°lisis de Rendimiento</h2>
                <p>Este gr√°fico muestra tu calificaci√≥n promedio por tipo de tiro. Te ayuda a identificar visualmente tus fortalezas y √°reas a mejorar.</p>
                <div style="width: 100%; max-width: 600px; margin: 20px auto; padding: 20px; background: var(--day-section-bg); border-radius: 5px;">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>`;
            htmlContentWrapper += analysisContent;

            // Add Progress Tab
            mobileNavOptions += `<option value="tab-progress">Mi Progreso</option>`;
            htmlTabs += `<input type="radio" name="tabs" id="tab-progress" class="tab-input"><label for="tab-progress" class="tab-label">Mi Progreso</label>`;
            let progressContent = `<div id="content-progress" class="tab-content">
                <h2>Mi Progreso Hist√≥rico</h2>
                <p>Este gr√°fico muestra el porcentaje de tareas que has completado en cada semana del plan. ¬°Es una excelente forma de visualizar tu consistencia y dedicaci√≥n!</p>
                <div style="width: 100%; max-width: 800px; margin: 20px auto; padding: 20px; background: var(--day-section-bg); border-radius: 5px;">
                    <canvas id="progressChart"></canvas>
                </div>
            </div>`;
            htmlContentWrapper += progressContent;

            tabsContainer.innerHTML = htmlTabs + `<div class="tab-content-wrapper">${htmlContentWrapper}</div>`;
            mobileNav.innerHTML = mobileNavOptions;
            
            mainContainer.style.display = 'block';
            [welcomeModal, loadUserModal, newUserModal].forEach(m => m.style.display = 'none');

            initializePlanLogic(totalWeeks);
        }

        function displayTodaysFocus(totalWeeks) {
            if (!currentProfile) return;

            const getSpanishDayName = () => {
                const days = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
                return days[new Date().getDay()];
            };

            const todayName = getSpanishDayName();
            const profiles = getProfiles();
            const user = profiles[currentProfile];
            if (!user || !user.config.selectedDays.includes(todayName)) {
                document.getElementById('todays-focus-container').style.display = 'none';
                return; // Not a training day
            }

            const progress = user.progress || {};
            let currentWeek = -1;
            let dayIndexOffset = 0;

            // Find the first incomplete week
            for (let i = 1; i <= totalWeeks; i++) {
                const daysInThisWeek = allTrainingDays.slice(dayIndexOffset, user.config.selectedDays.length ? dayIndexOffset + user.config.selectedDays.length : allTrainingDays.length);
                if (daysInThisWeek.length === 0) break;

                const tasksInWeek = daysInThisWeek.flatMap(d => d.tasks.map(t => `w${i}-d${d.id}-${t.id}`));
                const completedTasks = tasksInWeek.filter(taskId => progress[taskId] === true).length;
                
                if (completedTasks < tasksInWeek.length) {
                    currentWeek = i;
                    break;
                }
                dayIndexOffset += user.config.selectedDays.length;
            }

            if (currentWeek === -1 && totalWeeks > 0) {
                const container = document.getElementById('todays-focus-container');
                container.innerHTML = `<h3>¬°Felicidades!</h3><p>Has completado todo el plan de entrenamiento. ¬°Es hora de volver a empezar desde la Semana 1 para afianzar tu maestr√≠a!</p>`;
                container.style.display = 'block';
                return;
            }
            
            // Find today's training session within the current week
            const todayIndexInSchedule = user.config.selectedDays.indexOf(todayName);
            const trainingDayData = allTrainingDays[dayIndexOffset + todayIndexInSchedule];

            if (!trainingDayData) return;

            const container = document.getElementById('todays-focus-container');
            container.innerHTML = `
                <h3>Foco de Hoy: ${todayName}</h3>
                <p><strong>Sesi√≥n:</strong> ${trainingDayData.title.split(': ')[1]}</p>
                <p><strong>Meta:</strong> ${parseGlossaryTerms(trainingDayData.focus)}</p>
                <button id="goto-today-btn">Ir al Entrenamiento</button>
            `;
            container.style.display = 'block';

            document.getElementById('goto-today-btn').addEventListener('click', () => {
                const tabInput = document.getElementById(`tab${currentWeek}`);
                if (tabInput) {
                    tabInput.checked = true;
                    tabInput.dispatchEvent(new Event('change'));
                }
                
                setTimeout(() => {
                    const daySection = document.getElementById(`day-section-${trainingDayData.id}`);
                    if (daySection) {
                        daySection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        daySection.style.backgroundColor = 'var(--current-day-bg)';
                        setTimeout(() => {
                            daySection.style.backgroundColor = '';
                        }, 2000);
                    }
                }, 100);
            });
        }
        
        function generateProgressChart(totalWeeks) {
            const profiles = getProfiles();
            if (!currentProfile || !profiles[currentProfile]) return;
            
            const progress = profiles[currentProfile].progress || {};
            const userConfig = profiles[currentProfile].config;
            const daysPerWeek = userConfig.selectedDays.length;

            const labels = [];
            const data = [];
            let dayIndexOffset = 0;

            for (let i = 1; i <= totalWeeks; i++) {
                const daysInThisWeek = allTrainingDays.slice(dayIndexOffset, dayIndexOffset + daysPerWeek);
                if (daysInThisWeek.length === 0) break;
                
                const tasksInWeek = daysInThisWeek.flatMap(d => d.tasks.map(t => `w${i}-d${d.id}-${t.id}`));
                const totalTasks = tasksInWeek.length;
                if (totalTasks === 0) continue;

                const completedTasks = tasksInWeek.filter(taskId => progress[taskId] === true).length;
                const percentage = Math.round((completedTasks / totalTasks) * 100);

                labels.push(`Semana ${i}`);
                data.push(percentage);

                dayIndexOffset += daysPerWeek;
            }

            const ctx = document.getElementById('progressChart').getContext('2d');
            if (myProgressChart) {
                myProgressChart.destroy();
            }

            const isDarkMode = document.body.classList.contains('dark-mode');
            const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            const fontColor = isDarkMode ? '#e0e0e0' : '#333';
            
            myProgressChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '% Completado',
                        data: data,
                        backgroundColor: 'rgba(52, 152, 219, 0.6)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                color: fontColor,
                                callback: function(value) { return value + '%' }
                            },
                            grid: {
                                color: gridColor
                            }
                        },
                        x: {
                            ticks: {
                                color: fontColor
                            },
                             grid: {
                                color: 'transparent'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                             callbacks: {
                                label: function(context) {
                                    return `Completado: ${context.raw}%`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function generatePerformanceChart(totalWeeks) {
            const profiles = getProfiles();
            if (!currentProfile || !profiles[currentProfile]) return;
            const progress = profiles[currentProfile].progress || {};
            const ratings = progress.ratings || {};
            
            const performanceData = {};
            
            allTrainingDays.forEach(day => {
                day.tasks.forEach(task => {
                    if (task.type) {
                        if (!performanceData[task.type]) {
                            performanceData[task.type] = { total: 0, count: 0 };
                        }
                        const weekNum = Math.floor(allTrainingDays.findIndex(d => d.id === day.id) / profiles[currentProfile].config.selectedDays.length) + 1;
                        const taskId = `w${weekNum}-d${day.id}-${task.id}`;
                        if (ratings[taskId]) {
                            performanceData[task.type].total += ratings[taskId];
                            performanceData[task.type].count++;
                        }
                    }
                });
            });

            const labels = Object.keys(performanceData);
            const data = labels.map(label => {
                const item = performanceData[label];
                return item.count > 0 ? (item.total / item.count) : 0;
            });

            const ctx = document.getElementById('performanceChart').getContext('2d');
            if (myPerformanceChart) {
                myPerformanceChart.destroy();
            }
            
            const isDarkMode = document.body.classList.contains('dark-mode');
            const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.1)';
            const fontColor = isDarkMode ? '#e0e0e0' : '#333';
            const angleColor = isDarkMode ? 'rgba(255, 255, 255, 0.3)' : 'rgba(0, 0, 0, 0.2)';

            myPerformanceChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Rendimiento Promedio',
                        data: data,
                        fill: true,
                        backgroundColor: 'rgba(52, 152, 219, 0.2)',
                        borderColor: 'rgb(52, 152, 219)',
                        pointBackgroundColor: 'rgb(52, 152, 219)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgb(52, 152, 219)'
                    }]
                },
                options: {
                    scales: {
                        r: {
                            angleLines: { color: angleColor },
                            grid: { color: gridColor },
                            pointLabels: { color: fontColor, font: { size: 14 } },
                            ticks: {
                                backdropColor: 'transparent',
                                color: fontColor,
                                stepSize: 1,
                                max: 5,
                                min: 0
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function initializePlanLogic(totalWeeks) {
            const themeToggle = document.getElementById('theme-toggle');
            themeToggle.addEventListener('change', () => {
                document.body.classList.toggle('dark-mode');
                localStorage.setItem('tiroMaestroTheme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
                if(document.getElementById('tab-progress').checked) {
                    generateProgressChart(totalWeeks);
                }
                 if(document.getElementById('tab-analysis').checked) {
                    generatePerformanceChart(totalWeeks);
                }
            });
            if (localStorage.getItem('tiroMaestroTheme') === 'dark') { document.body.classList.add('dark-mode'); themeToggle.checked = true; }

            const mobileNav = document.getElementById('mobile-nav');
            const tabInputs = document.querySelectorAll('.tab-input');
            const btnResetCurrent = document.getElementById('btn-reset-current-week');
            
            function handleTabChange(e) {
                if(e.target.checked) {
                    const tabId = e.target.id;
                    document.querySelectorAll('.tab-content').forEach(tc => tc.style.display = 'none');
                    const contentId = `content${tabId.replace('tab','')}`;
                    document.getElementById(contentId).style.display = 'block';
                    mobileNav.value = tabId;
                    
                    if (tabId.includes('fitness') || tabId.includes('progress') || tabId.includes('reinforce') || tabId.includes('achievements') || tabId.includes('analysis')) {
                        btnResetCurrent.style.display = 'none';
                    } else {
                        btnResetCurrent.style.display = 'inline-block';
                        const weekNum = tabId.replace('tab', '');
                        btnResetCurrent.dataset.week = weekNum;
                        btnResetCurrent.textContent = `Reiniciar Semana ${weekNum}`;
                    }

                    if (tabId === 'tab-progress') generateProgressChart(totalWeeks);
                    if (tabId === 'tab-reinforce') populateReinforceList(totalWeeks);
                    if (tabId === 'tab-achievements') populateAchievementsTab(totalWeeks);
                    if (tabId === 'tab-analysis') generatePerformanceChart(totalWeeks);
                }
            }
            tabInputs.forEach(input => input.addEventListener('change', handleTabChange));
            mobileNav.addEventListener('change', (e) => {
                const tabInput = document.getElementById(e.target.value);
                if (tabInput) { tabInput.checked = true; tabInput.dispatchEvent(new Event('change')); }
            });

            function updateProgressForWeek(weekNumber) {
                const weekContent = document.getElementById(`content${weekNumber}`);
                if (!weekContent) return;
                const checkboxes = weekContent.querySelectorAll('input[type="checkbox"]');
                const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
                const totalCount = checkboxes.length;
                const percentage = (totalCount > 0) ? (checkedCount / totalCount) * 100 : 0;
                const progressBarFill = weekContent.querySelector('.progress-bar-fill');
                const taskCounter = weekContent.querySelector('.task-counter');
                if(progressBarFill) { progressBarFill.style.width = `${percentage}%`; progressBarFill.textContent = `${Math.round(percentage)}%`; }
                if(taskCounter) taskCounter.textContent = `Tareas: ${checkedCount} / ${totalCount}`;

                const assessmentSection = weekContent.querySelector('.assessment-section');
                if (assessmentSection) {
                    assessmentSection.style.display = (checkedCount === totalCount && totalCount > 0) ? 'block' : 'none';
                }
            }
            
            function saveState(id, value) {
                 if (!currentProfile) return;
                const profiles = getProfiles();
                if (!profiles[currentProfile]) profiles[currentProfile] = { config: {}, progress: {} };
                if (!profiles[currentProfile].progress) profiles[currentProfile].progress = {};
                profiles[currentProfile].progress[id] = value;
                saveProfiles(profiles);
            }
            
            function saveRating(taskId, rating) {
                if (!currentProfile) return;
                const profiles = getProfiles();
                if (!profiles[currentProfile]) return;
                if (!profiles[currentProfile].progress) profiles[currentProfile].progress = {};
                if (!profiles[currentProfile].progress.ratings) profiles[currentProfile].progress.ratings = {};
                
                if (rating === 0) {
                    delete profiles[currentProfile].progress.ratings[taskId];
                } else {
                    profiles[currentProfile].progress.ratings[taskId] = rating;
                }
                saveProfiles(profiles);
            }


            function toggleMarkedShot(taskId) {
                if (!currentProfile) return;
                const profiles = getProfiles();
                if (!profiles[currentProfile]) return;
                if (!profiles[currentProfile].progress) profiles[currentProfile].progress = {};
                if (!profiles[currentProfile].progress.markedShots) profiles[currentProfile].progress.markedShots = {};
                
                if (profiles[currentProfile].progress.markedShots[taskId]) {
                    delete profiles[currentProfile].progress.markedShots[taskId];
                } else {
                    profiles[currentProfile].progress.markedShots[taskId] = true;
                }
                saveProfiles(profiles);
            }

            function loadState() {
                if (!currentProfile) return;
                const profiles = getProfiles();
                const progress = profiles[currentProfile]?.progress || {};
                
                document.querySelectorAll('input[type="checkbox"], .diary-textarea').forEach(item => {
                    if (progress[item.id] !== undefined) {
                        if (item.type === 'checkbox') item.checked = progress[item.id];
                        else item.value = progress[item.id];
                    } else {
                        if (item.type === 'checkbox') item.checked = false;
                        else item.value = '';
                    }
                });

                const markedShots = progress.markedShots || {};
                document.querySelectorAll('.star-icon').forEach(star => {
                    star.classList.remove('marked');
                    star.innerHTML = '&#9734;';
                });
                for (const taskId in markedShots) {
                    const star = document.querySelector(`.star-icon[data-task-id="${taskId}"]`);
                    if (star) {
                        star.classList.add('marked');
                        star.innerHTML = '&#9733;';
                    }
                }
                
                const ratings = progress.ratings || {};
                document.querySelectorAll('.rating-stars').forEach(container => {
                    const taskId = container.dataset.taskId;
                    const rating = ratings[taskId];
                    if (rating) {
                        const stars = container.querySelectorAll('span');
                        stars.forEach(star => {
                            if (star.dataset.value <= rating) {
                                star.classList.add('filled');
                                star.innerHTML = '&#9733;';
                            } else {
                                star.classList.remove('filled');
                                star.innerHTML = '&#9734;';
                            }
                        });
                    }
                });
            }

            loadState();
            for(let i=1; i<=totalWeeks; i++) updateProgressForWeek(i);

            mainContainer.addEventListener('click', e => {
                if (e.target.classList.contains('star-icon')) {
                    const star = e.target;
                    star.classList.toggle('marked');
                    star.innerHTML = star.classList.contains('marked') ? '&#9733;' : '&#9734;';
                    toggleMarkedShot(star.dataset.taskId);
                } else if (e.target.closest('.rating-stars')) {
                    const star = e.target;
                    const container = e.target.closest('.rating-stars');
                    if (star.tagName !== 'SPAN') return;
                    
                    const newRating = parseInt(star.dataset.value, 10);
                    const taskId = container.dataset.taskId;

                    const profiles = getProfiles();
                    const currentRating = profiles[currentProfile]?.progress?.ratings?.[taskId];

                    let finalRating;

                    if (currentRating === newRating) {
                        finalRating = 0; // Clicked the same star, so reset
                    } else {
                        finalRating = newRating;
                    }

                    saveRating(taskId, finalRating);
                    
                    const allStars = container.querySelectorAll('span');
                    allStars.forEach(s => {
                        s.classList.remove('filled');
                        s.innerHTML = '&#9734;';
                    });

                    if (finalRating > 0) {
                        for (let i = 0; i < finalRating; i++) {
                            allStars[4-i].classList.add('filled');
                            allStars[4-i].innerHTML = '&#9733;';
                        }
                    }
                } else if (e.target.classList.contains('jump-to-task-btn')) {
                    const week = e.target.dataset.week;
                    const daySectionId = e.target.dataset.daySectionId;

                    const openModal = document.querySelector('.modal-overlay[style*="display: flex"]');
                    if(openModal) openModal.style.display = 'none';

                    const tabInput = document.getElementById(`tab${week}`);
                    if (tabInput) {
                        tabInput.checked = true;
                        tabInput.dispatchEvent(new Event('change'));
                    }
                    
                    setTimeout(() => {
                        const daySection = document.getElementById(daySectionId);
                        if (daySection) {
                            daySection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            daySection.style.backgroundColor = 'var(--current-day-bg)';
                            setTimeout(() => {
                                daySection.style.backgroundColor = '';
                            }, 2000);
                        }
                    }, 100);
                } else if (e.target.classList.contains('btn-start-session')) {
                    const timeStr = e.target.dataset.time;
                    const dayId = e.target.dataset.dayId;
                    startSessionMode(timeStr, dayId);
                }
            });

            document.querySelectorAll('input[type="checkbox"]').forEach(item => {
                item.addEventListener('change', (e) => {
                    saveState(e.target.id, e.target.checked);
                    const weekNumber = item.id.split('-')[0].replace('w','');
                    updateProgressForWeek(parseInt(weekNumber, 10));
                    updatePracticeStreak(totalWeeks);
                    checkAndAwardAchievements(totalWeeks);
                });
            });
             document.querySelectorAll('.diary-textarea').forEach(item => {
                item.addEventListener('input', e => saveState(e.target.id, e.target.value));
            });
            
            const resetModal = document.getElementById('reset-modal');
            const modalText = resetModal.querySelector('p');
            const confirmBtn = document.getElementById('modal-confirm');
            const cancelBtn = document.getElementById('modal-cancel');
            let weekToReset = null;
            let resetScope = 'current';

            btnResetCurrent.addEventListener('click', (e) => {
                weekToReset = e.currentTarget.dataset.week; resetScope = 'current';
                modalText.textContent = `¬øEst√°s seguro de que quieres borrar el progreso de la Semana ${weekToReset}?`;
                resetModal.style.display = 'flex';
            });
            document.getElementById('btn-reset-all').addEventListener('click', () => {
                resetScope = 'all'; modalText.textContent = '¬øEst√°s seguro de que quieres borrar el progreso de TODAS las semanas? Esta acci√≥n tambi√©n eliminar√° tus tiros marcados y logros.';
                resetModal.style.display = 'flex';
            });
            cancelBtn.addEventListener('click', () => resetModal.style.display = 'none');
            
            confirmBtn.addEventListener('click', () => {
                if (resetScope === 'current' && weekToReset) {
                    resetWeek(weekToReset);
                } else if (resetScope === 'all') {
                    const profiles = getProfiles();
                    if (profiles[currentProfile]) {
                        profiles[currentProfile].progress = {};
                        saveProfiles(profiles);
                    }
                    window.location.reload();
                }
                resetModal.style.display = 'none';
            });

            function resetWeek(weekNum) {
                const weekContent = document.getElementById(`content${weekNum}`);
                if(!weekContent) return;
                const profiles = getProfiles();
                if (!profiles[currentProfile]?.progress) return;
                
                weekContent.querySelectorAll('input[type="checkbox"], .diary-textarea, .star-icon, .rating-stars').forEach(item => {
                    const progress = profiles[currentProfile].progress;
                    if(item.classList.contains('star-icon')) {
                         if (progress.markedShots && progress.markedShots[item.dataset.taskId]) {
                            delete progress.markedShots[item.dataset.taskId];
                        }
                        item.classList.remove('marked');
                        item.innerHTML = '&#9734;';
                    } else if (item.classList.contains('rating-stars')) {
                        if(progress.ratings && progress.ratings[item.dataset.taskId]) {
                            delete progress.ratings[item.dataset.taskId];
                        }
                        item.querySelectorAll('span').forEach(star => {
                            star.classList.remove('filled');
                            star.innerHTML = '&#9734;';
                        });
                    }
                    else {
                        if (progress[item.id]) {
                            delete progress[item.id];
                        }
                        if(item.type === 'checkbox') item.checked = false; else item.value = '';
                    }
                });
                saveProfiles(profiles);
                updateProgressForWeek(weekNum);
            }

            const glossaryModal = document.getElementById('glossary-modal');
            const termDefinitionModal = document.getElementById('term-definition-modal');
            const tooltip = document.getElementById('tooltip');
            
            mainContainer.addEventListener('mouseover', (e) => {
                if (e.target.classList.contains('glossary-term')) {
                    const term = e.target.dataset.term;
                    tooltip.innerHTML = `<strong>${term} / ${glossaryData[term].translation}</strong>: ${glossaryData[term].definition}`;
                    tooltip.style.display = 'block';
                    const rect = e.target.getBoundingClientRect();
                    tooltip.style.left = `${rect.left + window.scrollX}px`;
                    tooltip.style.top = `${rect.bottom + window.scrollY + 5}px`;
                }
            });
             mainContainer.addEventListener('mouseout', (e) => {
                if (e.target.classList.contains('glossary-term')) tooltip.style.display = 'none';
            });
             mainContainer.addEventListener('click', (e) => {
                 if (e.target.classList.contains('glossary-term')) {
                    tooltip.style.display = 'none';
                    const term = e.target.dataset.term;
                    const data = glossaryData[term];
                    document.getElementById('term-modal-title').textContent = `${term} / ${data.translation}`;
                    document.getElementById('term-modal-definition').textContent = data.definition;
                    termDefinitionModal.style.display = 'flex';
                 }
             });
            
            document.querySelectorAll('.modal-close-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.target.closest('.modal-overlay').style.display = 'none';
                });
            });
            
            document.querySelectorAll('.btn-get-recommendation').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const form = e.target.closest('form');
                    const errorMessage = form.querySelector('.error-message');
                    const criteriaMet = form.querySelector('input[name="criteria-met"]:checked');
                    
                    errorMessage.style.display = 'none';

                    if (!criteriaMet) {
                        errorMessage.style.display = 'block';
                        return;
                    }

                    const confidence = form.querySelector('select[name="confidence"]');
                    const recommendationText = document.getElementById('recommendation-text');
                    if (criteriaMet.value === 'no' || (criteriaMet.value === 'somewhat' && parseInt(confidence.value) < 3)) {
                        recommendationText.innerHTML = "<strong>Recomendaci√≥n: Repetir la semana.</strong><br>Parece que todav√≠a hay conceptos clave que necesitan refuerzo. Repetir los ejercicios te ayudar√° a construir una base m√°s s√≥lida antes de avanzar. ¬°La consistencia es la clave!";
                    } else {
                        recommendationText.innerHTML = "<strong>Recomendaci√≥n: ¬°Avanzar a la siguiente semana!</strong><br>¬°Excelente trabajo! Has demostrado un buen dominio de los conceptos de esta semana. Est√°s listo para enfrentar nuevos desaf√≠os.";
                    }
                    document.getElementById('recommendation-modal').style.display = 'flex';
                });
            });

            const diagramModal = document.getElementById('diagram-modal');
            const diagramImage = document.getElementById('diagram-modal-image');
            const diagramTitle = document.getElementById('diagram-modal-title');

            document.querySelectorAll('.btn-view-diagram').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const dayId = e.target.dataset.dayId;
                    const dayData = allTrainingDays.find(d => d.id == dayId);
                    if (dayData && dayData.diagrama) {
                        diagramImage.src = dayData.diagrama;
                        diagramTitle.textContent = `Diagrama: ${e.target.dataset.diagramTitle}`;
                        diagramModal.style.display = 'flex';
                    }
                });
            });


            document.getElementById('btn-glossary').addEventListener('click', () => glossaryModal.style.display = 'flex');
            document.getElementById('btn-print').addEventListener('click', () => window.print());
            
            document.getElementById('btn-change-user').addEventListener('click', () => {
                mainContainer.style.display = 'none';
                currentProfile = null;
                isGuest = false;
                if(myProgressChart) myProgressChart.destroy();
                if(myPerformanceChart) myPerformanceChart.destroy();
                myProgressChart = null;
                myPerformanceChart = null;
                showModal(welcomeModal);
            });

            document.getElementById('btn-export-profile').addEventListener('click', () => {
                if (!currentProfile || isGuest) {
                    showCustomAlert('Error', 'Solo los perfiles guardados pueden ser exportados.');
                    return;
                }
                const profiles = getProfiles();
                const profileData = profiles[currentProfile];
                if (!profileData) {
                    showCustomAlert('Error', 'No se encontraron datos para el perfil actual.');
                    return;
                }

                const exportObj = { profileName: currentProfile, profileData: profileData };
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportObj, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", `tiro_maestro_perfil_${currentProfile}.json`);
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            });
            
            document.getElementById('btn-edit-plan').addEventListener('click', () => {
                if (isGuest) { window.location.reload(); return; }
                
                const profiles = getProfiles();
                const userConfig = profiles[currentProfile].config;
                
                setupForm.dataset.mode = 'edit';
                setupForm.dataset.originalName = currentProfile;
                document.getElementById('new-user-title').textContent = `Editar Perfil de ${currentProfile}`;
                document.getElementById('user-name').value = currentProfile;
                document.getElementById('user-name').disabled = false;
                setupForm.querySelector('button[type="submit"]').textContent = 'Actualizar Mi Plan';
                
                document.querySelectorAll('#training-days-group input').forEach(cb => {
                    cb.checked = userConfig.selectedDays.includes(cb.value);
                });

                document.getElementById('btn-cancel-edit').style.display = 'inline-block';
                document.getElementById('back-button-container').style.display = 'none';
                showModal(newUserModal);
            });
            document.getElementById('btn-cancel-edit').addEventListener('click', () => {
                 showModal(null); // Hides all modals
                 mainContainer.style.display = 'block';
            });
            
             const firstTab = document.querySelector('.tab-input');
             if(firstTab) firstTab.dispatchEvent(new Event('change'));

             displayTodaysFocus(totalWeeks);
             initializeNewFeatures(totalWeeks);
        }
        
        const glossaryContent = document.getElementById('glossary-content');
        const sortedGlossary = Object.keys(glossaryData).sort((a, b) => a.localeCompare(b));
        let glossaryHTML = '<dl>';
        sortedGlossary.forEach(term => glossaryHTML += `<dt>${term} / ${glossaryData[term].translation}</dt><dd>${glossaryData[term].definition}</dd>`);
        glossaryHTML += '</dl>';
        glossaryContent.innerHTML = glossaryHTML;

        // --- GLOBAL INITIALIZATION LOGIC ---
        
        document.getElementById('alert-ok').addEventListener('click', () => {
            document.getElementById('alert-modal').style.display = 'none';
        });

        document.getElementById('achievement-ok-btn').addEventListener('click', () => {
             document.getElementById('achievement-unlocked-modal').style.display = 'none';
        });

        const importFileInput = document.getElementById('import-file-input');
        const overwriteModal = document.getElementById('overwrite-modal');
        let pendingImport = null;

        document.getElementById('btn-import-profile').addEventListener('click', () => {
            importFileInput.click();
        });

        importFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const imported = JSON.parse(event.target.result);
                    if (!imported.profileName || !imported.profileData || !imported.profileData.config || !imported.profileData.progress) {
                        showCustomAlert('Error de Importaci√≥n', 'El archivo de perfil no tiene el formato correcto.');
                        return;
                    }

                    const { profileName, profileData } = imported;
                    const profiles = getProfiles();

                    if (profiles[profileName]) {
                        document.getElementById('overwrite-modal-text').textContent = `Ya existe un perfil llamado "${profileName}". ¬øDeseas sobrescribirlo con los datos del archivo? Se perder√° el progreso actual de ese perfil.`;
                        pendingImport = { profileName, profileData };
                        overwriteModal.style.display = 'flex';
                    } else {
                        profiles[profileName] = profileData;
                        saveProfiles(profiles);
                        showCustomAlert('√âxito', `El perfil "${profileName}" se ha importado correctamente.`);
                    }
                } catch (err) {
                    showCustomAlert('Error de Importaci√≥n', 'El archivo seleccionado no es un JSON v√°lido.');
                } finally {
                    importFileInput.value = '';
                }
            };
            reader.readAsText(file);
        });

        document.getElementById('overwrite-confirm').addEventListener('click', () => {
            if (pendingImport) {
                const { profileName, profileData } = pendingImport;
                const profiles = getProfiles();
                profiles[profileName] = profileData;
                saveProfiles(profiles);
                showCustomAlert('√âxito', `El perfil "${profileName}" se ha sobrescrito e importado correctamente.`);
                pendingImport = null;
            }
            overwriteModal.style.display = 'none';
        });

        document.getElementById('overwrite-cancel').addEventListener('click', () => {
            pendingImport = null;
            overwriteModal.style.display = 'none';
        });

        showModal(welcomeModal);

        setupForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const isEditMode = setupForm.dataset.mode === 'edit';
            const userNameInput = document.getElementById('user-name');
            const nameError = document.getElementById('name-error');
            const daysError = document.getElementById('days-error');
            const selectedCheckboxes = document.querySelectorAll('#training-days-group input:checked');
            const selectedDays = Array.from(selectedCheckboxes).map(cb => cb.value);

            let isValid = true;
            nameError.style.display = 'none'; daysError.style.display = 'none';
            if (userNameInput.value.trim() === '') { nameError.style.display = 'block'; isValid = false; }
            if (selectedDays.length < 2) { daysError.style.display = 'block'; isValid = false; }
            if (!isValid) return;

            const userName = userNameInput.value.trim();
            const userConfig = { selectedDays };

            if (isEditMode) {
                const originalName = setupForm.dataset.originalName;
                const profiles = getProfiles();
                
                if (originalName !== userName && profiles[userName]) {
                    nameError.textContent = 'Este nombre de perfil ya existe. Por favor, elige otro.';
                    nameError.style.display = 'block';
                    return;
                }
                
                const currentProgress = profiles[originalName] ? profiles[originalName].progress : {};
                if (originalName !== userName) {
                    delete profiles[originalName];
                }
                
                profiles[userName] = { config: userConfig, progress: currentProgress };
                saveProfiles(profiles);
                startSession(userName);

            } else { // New user mode
                const profiles = getProfiles();
                if (profiles[userName] && !isGuest) { // Check for existing name only for non-guests
                    nameError.textContent = 'Este nombre de perfil ya existe. Por favor, elige otro.';
                    nameError.style.display = 'block';
                    return;
                }
                profiles[userName] = { config: userConfig, progress: {} };
                saveProfiles(profiles);
                startSession(userName, isGuest ? userConfig : null);
            }
            
            const submitButton = setupForm.querySelector('button[type="submit"]');
            submitButton.textContent = 'Crear Mi Plan';
            userNameInput.disabled = false;
            setupForm.removeAttribute('data-mode');
            setupForm.removeAttribute('data-original-name');
            setupForm.reset();
        });

        function populateReinforceList(totalWeeks) {
            const list = document.getElementById('reinforce-list');
            const profiles = getProfiles();
            if (!currentProfile || !profiles[currentProfile]) return;
            const markedShots = profiles[currentProfile].progress?.markedShots || {};
            
            list.innerHTML = ''; // Clear list

            if (Object.keys(markedShots).length === 0) {
                list.innerHTML = '<p>A√∫n no has marcado ning√∫n tiro como problem√°tico. Haz clic en la estrella (&#9734;) junto a un ejercicio para a√±adirlo aqu√≠.</p>';
                return;
            }

            for (const taskId in markedShots) {
                const [weekPart, dayPart, taskPart] = taskId.split('-');
                const weekNum = parseInt(weekPart.replace('w', ''), 10);
                const dayId = parseInt(dayPart.replace('d', ''), 10);
                const taskIdNum = taskPart;

                // Find the correct day and task
                const dayData = allTrainingDays.find(d => d.id === dayId);
                const taskData = dayData?.tasks.find(t => t.id === taskIdNum);

                if(dayData && taskData) {
                    const li = document.createElement('li');
                    li.className = 'reinforce-item';
                    li.innerHTML = `
                        <div class="reinforce-item-text">
                            ${parseGlossaryTerms(taskData.text)}
                            <span class="reinforce-item-source">De: Semana ${weekNum}, ${dayData.title}</span>
                        </div>
                        <button class="jump-to-task-btn" data-week="${weekNum}" data-day-section-id="day-section-${dayId}" style="background-color: var(--accent-color); color: white; border:none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">Ir al Ejercicio</button>
                    `;
                    list.appendChild(li);
                }
            }
        }

        function initializeNewFeatures(totalWeeks) {
            const shotOfTheDayModal = document.getElementById('shot-of-the-day-modal');
            const shotOfTheDayContent = document.getElementById('shot-of-the-day-content');

            document.getElementById('btn-shot-of-the-day').addEventListener('click', () => {
                const profiles = getProfiles();
                const progress = profiles[currentProfile]?.progress || {};
                const userConfig = profiles[currentProfile]?.config;
                const daysPerWeek = userConfig.selectedDays.length;

                const markedShots = progress.markedShots || {};
                const ratings = progress.ratings || {};

                // 1. Prioritize marked shots
                const markedShotIds = Object.keys(markedShots);
                if (markedShotIds.length > 0) {
                    const randomMarkedId = markedShotIds[Math.floor(Math.random() * markedShotIds.length)];
                    displayIntelligentShot(randomMarkedId, "Reforzar un tiro problem√°tico:");
                    return;
                }

                // 2. Find lowest rated shot from completed weeks
                let completedWeeksTasks = [];
                let dayIndexOffset = 0;
                for (let i = 1; i <= totalWeeks; i++) {
                    const daysInThisWeek = allTrainingDays.slice(dayIndexOffset, dayIndexOffset + daysPerWeek);
                    if (daysInThisWeek.length === 0) break;
                    
                    const tasksInWeek = daysInThisWeek.flatMap(d => d.tasks.map(t => ({ taskId: `w${i}-d${d.id}-${t.id}`, day: d, task: t, week: i })));
                    const totalTasks = tasksInWeek.length;
                    const completedTasksCount = tasksInWeek.filter(t => progress[t.taskId]).length;

                    if (totalTasks > 0 && completedTasksCount === totalTasks) {
                        completedWeeksTasks.push(...tasksInWeek);
                    }
                    dayIndexOffset += daysPerWeek;
                }

                const lowRatedTasks = completedWeeksTasks.filter(t => ratings[t.taskId] && ratings[t.taskId] < 3);
                 if (lowRatedTasks.length > 0) {
                    const randomLowRated = lowRatedTasks[Math.floor(Math.random() * lowRatedTasks.length)];
                    displayIntelligentShot(randomLowRated.taskId, "Reforzar un tiro con bajo rendimiento:");
                    return;
                }

                // 3. Fallback to random shot from completed weeks
                if (completedWeeksTasks.length > 0) {
                    const randomTask = completedWeeksTasks[Math.floor(Math.random() * completedWeeksTasks.length)];
                    displayIntelligentShot(randomTask.taskId, "Para repasar, te sugerimos practicar:");
                } else {
                     shotOfTheDayContent.innerHTML = `<p style="text-align: center;">Completa al menos una semana al 100% para desbloquear el "Tiro del D√≠a". ¬°Sigue practicando!</p>`;
                }
                shotOfTheDayModal.style.display = 'flex';
            });

            function displayIntelligentShot(taskId, reasonText) {
                 const [weekPart, dayPart, taskPart] = taskId.split('-');
                const weekNum = parseInt(weekPart.replace('w', ''), 10);
                const dayId = parseInt(dayPart.replace('d', ''), 10);
                const taskIdNum = taskPart;

                const dayData = allTrainingDays.find(d => d.id === dayId);
                const taskData = dayData?.tasks.find(t => t.id === taskIdNum);

                if (dayData && taskData) {
                    shotOfTheDayContent.innerHTML = `
                        <p>${reasonText}</p>
                        <div class="reinforce-item">
                           <div class="reinforce-item-text">
                                ${parseGlossaryTerms(taskData.text)}
                                <span class="reinforce-item-source">De: Semana ${weekNum}, ${dayData.title}</span>
                           </div>
                           <button class="jump-to-task-btn" data-week="${weekNum}" data-day-section-id="day-section-${dayId}" style="background-color: var(--accent-color); color: white; border:none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">Ir al Ejercicio</button>
                        </div>
                    `;
                    shotOfTheDayModal.style.display = 'flex';
                }
            }
        }
        
        function populateAchievementsTab(totalWeeks) {
            const grid = document.getElementById('achievements-grid');
            const profiles = getProfiles();
            const progress = profiles[currentProfile]?.progress || {};
            const unlocked = progress.unlockedAchievements || {};
            grid.innerHTML = '';

            for (const id in achievementsData) {
                const ach = achievementsData[id];
                const isUnlocked = unlocked[id];
                const div = document.createElement('div');
                div.className = 'achievement-item';
                if (isUnlocked) {
                    div.classList.add('unlocked');
                }
                div.innerHTML = `
                    <div class="achievement-icon">${ach.icon}</div>
                    <div class="achievement-details">
                        <h4>${ach.name}</h4>
                        <p>${ach.desc}</p>
                    </div>
                `;
                grid.appendChild(div);
            }

            // Update streak counter
            const streak = progress.currentStreak || 0;
            document.getElementById('streak-counter').innerHTML = `${streak} üî•`;
        }

        function checkAndAwardAchievements(totalWeeks) {
            const profiles = getProfiles();
            if (!currentProfile || !profiles[currentProfile]) return;
            const progress = profiles[currentProfile].progress || {};
            const userConfig = profiles[currentProfile].config;
            if (!progress.unlockedAchievements) progress.unlockedAchievements = {};
            
            for (const id in achievementsData) {
                if (!progress.unlockedAchievements[id]) { // If not already unlocked
                    const ach = achievementsData[id];
                    if (ach.condition(progress, userConfig, totalWeeks)) {
                        progress.unlockedAchievements[id] = true;
                        saveProfiles(profiles);
                        // Show notification modal
                        document.getElementById('unlocked-achievement-icon').textContent = ach.icon;
                        document.getElementById('unlocked-achievement-name').textContent = ach.name;
                        document.getElementById('unlocked-achievement-desc').textContent = ach.desc;
                        document.getElementById('achievement-unlocked-modal').style.display = 'flex';
                    }
                }
            }
        }

        function updatePracticeStreak(totalWeeks) {
            const profiles = getProfiles();
            if (!currentProfile || !profiles[currentProfile]) return;
            const progress = profiles[currentProfile].progress || {};

            const today = new Date().toISOString().split('T')[0];
            const lastPractice = progress.lastPracticeDate;
            let streak = progress.currentStreak || 0;

            if (lastPractice === today) return; // Already practiced today

            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];

            if (lastPractice === yesterdayStr) {
                streak++; // Continue streak
            } else {
                streak = 1; // Reset streak
            }

            progress.currentStreak = streak;
            progress.lastPracticeDate = today;
            saveProfiles(profiles);
        }

    });
    </script>
</body>
</html>

